<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Data Deletion Tool</title>
    
    <!-- Supabase JavaScript Library -->
<!-- External JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="auth.js"></script>
    <style>
        /* Admin Logout Button - Add to existing styles */
.admin-logout-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    z-index: 9998;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    transition: all 0.3s ease;
}

.admin-logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
}

.admin-logout-btn:active {
    transform: translateY(0);
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .warning-banner {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .config-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }

        .config-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .deletion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .deletion-card {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .deletion-card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .deletion-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .deletion-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .stats-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .stats-display strong {
            color: #2c3e50;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .confirmation-box {
            background: #fff3cd;
            border: 2px solid #f39c12;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .confirmation-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .emergency-section {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            text-align: center;
        }

        .emergency-section h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .col {
            flex: 1;
        }

        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .deletion-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #27ae60;
        }

        .status-disconnected {
            background: #e74c3c;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .search-no-results {
            padding: 12px 15px;
            color: #666;
            font-style: italic;
            text-align: center;
        }

        .loan-id {
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <button id="adminLogoutBtn" class="admin-logout-btn" onclick="adminLogout()" title="Logout from admin panel">
    üö™ Logout
</button>
    <div class="container">
        <div class="header">
            <h1>üóëÔ∏è Supabase Data Deletion Tool</h1>
            <p>Safely delete data from your Society Management System database</p>
        </div>

        <div class="content">
            <div class="warning-banner">
                ‚ö†Ô∏è WARNING: This tool permanently deletes data from your database. Actions cannot be undone!
                Always backup your data before performing any deletions.
            </div>

            <!-- Database Configuration -->
            <div class="config-section">
                <h3>üì° Database Connection</h3>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="supabaseUrl">Supabase Project URL</label>
                            <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co" value="https://lvsekyzhwwaezwfltxzr.supabase.co">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="supabaseKey">Supabase Anon Key</label>
                            <input type="password" id="supabaseKey" placeholder="Your anon key" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2c2VreXpod3dhZXp3Zmx0eHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MjYyOTYsImV4cCI6MjA2NjUwMjI5Nn0.ZvHWrqxohHLGzLJIDgSr_y1L4MfMsO_bWdERxAoakK8">
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="connectToDatabase()">
                    <span id="connectionStatus">üîå Connect to Database</span>
                </button>
                <div id="connectionResult"></div>
            </div>
            <!-- Database Backup & Restore -->
            <div class="config-section">
                <h3>üíæ Database Backup & Restore</h3>
                <div class="row">
                    <div class="col">
                        <h4>üîÑ Full Database Backup</h4>
                        <p>Export complete database as JSON backup file</p>
                        <button class="btn btn-success" onclick="exportFullDatabaseBackup()">
                            üíæ Export Full Database
                        </button>
                    </div>
                    <div class="col">
                        <h4>üìä Export Members as Excel</h4>
                        <p>Export member data in Excel format for external use</p>
                        <button class="btn btn-primary" onclick="exportMembersToExcel()">
                            üìÑ Export Members Excel
                        </button>
                    </div>
                </div>
                
                <div class="row" style="margin-top: 20px;">
                    <div class="col">
                        <h4>üì• Restore Database</h4>
                        <p>Restore database from a previously exported backup file</p>
                        <div class="form-group">
                            <label for="restoreFile">Select Backup File</label>
                            <input type="file" id="restoreFile" accept=".json" onchange="handleRestoreFile(event)">
                        </div>
                        <button class="btn btn-warning" onclick="restoreDatabase()" id="restoreBtn" style="display: none;">
                            üîÑ Restore Database
                        </button>
                    </div>
                    <div class="col">
                        <div id="restorePreview" style="display: none;">
                            <h4>üìã Backup File Preview</h4>
                            <div id="restoreFileInfo"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Table Statistics -->
            <div id="tableStats" style="display: none;">
                <h3>üìä Current Database Statistics</h3>
                <div id="statsContent"></div>
                <button class="btn btn-success" onclick="refreshStats()">üîÑ Refresh Statistics</button>
            </div>

            <!-- Deletion Operations -->
            <div id="deletionOperations" style="display: none;">
                <h3>üóëÔ∏è Deletion Operations</h3>
                
                <div class="deletion-grid">
                    <!-- Individual Table Deletions -->
                    <div class="deletion-card">
                        <h4>üßπ Clear Individual Tables</h4>
                        <p>Delete all data from a specific table while keeping the table structure.</p>
                        
                        <div class="form-group">
                            <label for="tableSelect">Select Table to Clear</label>
                            <select id="tableSelect">
                                <option value="">Choose a table...</option>
                                <option value="subscriptions">Subscriptions</option>
                                <option value="loan_repayments">Loan Repayments</option>
                                <option value="loan_interest_accruals">Loan Interest Accruals</option>
                                <option value="fd_interest_calculations">FD Interest Calculations</option>
                                <option value="member_pins">Member PINs (üîë Login PINs)</option>
                                <option value="loans">Loans (‚ö†Ô∏è Will also clear repayments & interest)</option>
                                <option value="fixed_deposits">Fixed Deposits (‚ö†Ô∏è Will also clear FD interest)</option>
                                <option value="members">Members (‚ö†Ô∏è Will clear ALL related data including PINs)</option>
                                <option value="quarter_settings">Quarter Settings</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-warning" onclick="clearSingleTable()">üóëÔ∏è Clear Selected Table</button>
                    </div>

                    <!-- Selective Data Deletion -->
                    <div class="deletion-card">
                        <h4>üéØ Selective Data Deletion</h4>
                        <p>Delete specific records based on date ranges or other criteria.</p>
                        
                        <div class="form-group">
                            <label for="selectiveOperation">Deletion Type</label>
                            <select id="selectiveOperation">
                                <option value="">Choose operation...</option>
                                <option value="old_subscriptions">Delete old subscriptions (before date)</option>
                                <option value="old_repayments">Delete old loan repayments (before date)</option>
                                <option value="old_interest">Delete old interest accruals (before date)</option>
                                <option value="closed_loans">Delete fully repaid loans</option>
                                <option value="orphaned_pins">Delete orphaned member PINs</option>
                                <option value="test_data">Delete test/demo data</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="dateGroup" style="display: none;">
                            <label for="cutoffDate">Cutoff Date</label>
                            <input type="date" id="cutoffDate">
                        </div>
                        
                        <button class="btn btn-warning" onclick="performSelectiveDeletion()">üéØ Delete Selected Data</button>
                    </div>

                    <!-- Financial Data Reset -->
                    <div class="deletion-card">
                        <h4>üí∞ Financial Data Reset</h4>
                        <p>Reset financial calculations while keeping member data intact.</p>
                        
                        <div class="confirmation-box">
                            <h4>This will delete:</h4>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>All loan interest accruals</li>
                                <li>All FD interest calculations</li>
                                <li>All loan repayments</li>
                                <li>Reset loan outstanding amounts</li>
                                <li><strong>Member PINs will be preserved</strong></li>
                            </ul>
                        </div>
                        
                        <button class="btn btn-danger" onclick="resetFinancialData()">üí∞ Reset Financial Data</button>
                    </div>

                    <!-- Specific Loan Deletion -->
                    <div class="deletion-card">
                        <h4>üéØ Delete Specific Loan</h4>
                        <p>Delete a particular loan and all its related data (repayments, interest accruals). Use this for inadvertent loan issues.</p>
                        
                        <div class="form-group">
                            <label for="loanSearchInput">Search Loan by ID or Member Name</label>
                            <div style="position: relative;">
                                <input type="text" id="loanSearchInput" placeholder="Enter Loan ID (e.g., LN0001) or Member Name" autocomplete="off">
                                <div id="loanSearchResults" class="search-results"></div>
                                <input type="hidden" id="selectedLoanId">
                            </div>
                        </div>
                        
                        <div id="selectedLoanDetails" style="display: none;" class="confirmation-box">
                            <h4>Selected Loan Details:</h4>
                            <div id="loanDetailsContent"></div>
                        </div>
                        
                        <button class="btn btn-danger" onclick="deleteSpecificLoan()" id="deleteLoanBtn" style="display: none;">
                            üóëÔ∏è Delete This Loan Permanently
                        </button>
                    </div>

                    <!-- Member Data Management -->
                    <div class="deletion-card">
                        <h4>üë• Member Data Management</h4>
                        <p>Manage member records and their associated data including login PINs.</p>
                        
                        <div class="form-group">
                            <label for="memberAction">Member Action</label>
                            <select id="memberAction">
                                <option value="">Choose action...</option>
                                <option value="delete_suspended">Delete suspended members (+ their PINs)</option>
                                <option value="delete_inactive">Delete inactive members (+ their PINs)</option>
                                <option value="cleanup_duplicates">Remove duplicate members (+ their PINs)</option>
                                <option value="reset_all_pins">Reset all member PINs to default</option>
                                <option value="clear_custom_pins">Clear all custom PINs (keep defaults)</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-warning" onclick="performMemberAction()">üë• Execute Member Action</button>
                    </div>
                </div>

                <!-- Emergency Section -->
                <div class="emergency-section">
                    <h3>üö® Emergency Operations</h3>
                    <p>Use these operations only in emergency situations. They will permanently delete large amounts of data.</p>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn btn-success" onclick="exportDataBeforeDeletion()" style="margin: 10px;">
                            üíæ Export Data Backup First
                        </button>
                        <button class="btn btn-danger" onclick="clearAllTransactionData()" style="margin: 10px;">
                            üß® Clear ALL Transaction Data (Keep Members & PINs)
                        </button>
                        <button class="btn btn-danger" onclick="resetCompleteDatabase()" style="margin: 10px;">
                            üí£ RESET ENTIRE DATABASE (Including PINs)
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9em; opacity: 0.8; margin-top: 15px;">
                        These operations require multiple confirmations and cannot be undone.
                    </p>
                </div>
            </div>

            <!-- Results Area -->
            <div id="resultsArea"></div>
        </div>
    </div>

    <script>
        let supabase = null;
        let isConnected = false;

        // Initialize loan search functionality
        function initializeLoanSearch() {
            const searchInput = document.getElementById('loanSearchInput');
            const resultsDiv = document.getElementById('loanSearchResults');
            const hiddenInput = document.getElementById('selectedLoanId');
            const detailsDiv = document.getElementById('selectedLoanDetails');
            const deleteBtn = document.getElementById('deleteLoanBtn');

            if (!searchInput || !resultsDiv || !hiddenInput) return;

            let searchTimeout;

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (searchTerm.length < 2) {
                    resultsDiv.style.display = 'none';
                    hiddenInput.value = '';
                    detailsDiv.style.display = 'none';
                    deleteBtn.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(async () => {
                    await searchLoans(searchTerm);
                }, 300);
            });

            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        // Search for loans
        async function searchLoans(searchTerm) {
            if (!isConnected) return;

            try {
                const resultsDiv = document.getElementById('loanSearchResults');
                
                // Clean the search term
                const cleanTerm = searchTerm.trim();
                console.log('Searching for:', cleanTerm);
                
                // Check if it's a loan ID pattern (LN followed by numbers, or just numbers)
                const isLoanId = /^(LN)?\d+$/i.test(cleanTerm);
                console.log('Is loan ID:', isLoanId);
                
                let loans = [];
                
                if (isLoanId) {
                    // Extract numeric part from loan ID
                    const numericId = parseInt(cleanTerm.replace(/^LN/i, '').replace(/^0+/, '')) || 0;
                    console.log('Searching for loan ID:', numericId);
                    
                    const { data, error } = await supabase
                        .from('loans')
                        .select(`
                            id, amount, outstanding_amount, loan_date, status, interest_rate_type, manual_interest_rate,
                            members(name, contact)
                        `)
                        .eq('id', numericId);
                    
                    if (error) {
                        console.error('Loan ID search error:', error);
                        throw error;
                    }
                    loans = data || [];
                    console.log('Loan ID results:', loans);
                    
                } else {
                    // Search by member name only
                    console.log('Searching by member name:', cleanTerm);
                    
                    const { data, error } = await supabase
                        .from('loans')
                        .select(`
                            id, amount, outstanding_amount, loan_date, status, interest_rate_type, manual_interest_rate,
                            members!inner(name, contact)
                        `)
                        .ilike('members.name', `%${cleanTerm}%`)
                        .order('loan_date', { ascending: false })
                        .limit(10);
                    
                    if (error) {
                        console.error('Member name search error:', error);
                        throw error;
                    }
                    loans = data || [];
                    console.log('Member name results:', loans);
                }

                displayLoanSearchResults(loans);

            } catch (error) {
                console.error('Error searching loans:', error);
                
                // Show user-friendly error message
                const resultsDiv = document.getElementById('loanSearchResults');
                resultsDiv.innerHTML = '<div class="search-no-results">‚ùå Error searching loans. Please try again or check your search term.</div>';
                resultsDiv.style.display = 'block';
                
                // Also show alert
                showAlert('Search error: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // Display loan search results
        function displayLoanSearchResults(loans) {
            const resultsDiv = document.getElementById('loanSearchResults');
            
            if (loans.length === 0) {
                resultsDiv.innerHTML = '<div class="search-no-results">No loans found</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            let html = '';
            loans.forEach(loan => {
                const loanId = `LN${String(loan.id).padStart(4, '0')}`;
                const outstanding = loan.outstanding_amount || loan.amount;
                const statusBadge = loan.status === 'active' ? 'üü¢ Active' : 'üî¥ Closed';
                
                let rateInfo = '';
                if (loan.interest_rate_type === 'progressive') {
                    rateInfo = '2%/3% Progressive';
                } else if (loan.interest_rate_type === 'flat') {
                    rateInfo = `${loan.manual_interest_rate}% Flat`;
                } else {
                    rateInfo = '0% Interest';
                }

                html += `
                    <div class="search-result-item" onclick="selectLoan(${loan.id}, '${loan.members.name.replace(/'/g, "\\'")}', ${loan.amount}, ${outstanding}, '${loan.loan_date}', '${loan.status}', '${rateInfo}')">
                        <div class="loan-id">${loanId} - ${loan.members.name}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">
                            Amount: ‚Çπ${loan.amount.toLocaleString()} | Outstanding: ‚Çπ${outstanding.toLocaleString()}
                        </div>
                        <div style="font-size: 11px; color: #888; margin-top: 2px;">
                            ${statusBadge} | ${rateInfo} | ${new Date(loan.loan_date).toLocaleDateString()}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // Select a loan from search results
        function selectLoan(loanId, memberName, amount, outstanding, loanDate, status, rateInfo) {
            const searchInput = document.getElementById('loanSearchInput');
            const resultsDiv = document.getElementById('loanSearchResults');
            const hiddenInput = document.getElementById('selectedLoanId');
            const detailsDiv = document.getElementById('selectedLoanDetails');
            const detailsContent = document.getElementById('loanDetailsContent');
            const deleteBtn = document.getElementById('deleteLoanBtn');

            // Update form
            const loanIdFormatted = `LN${String(loanId).padStart(4, '0')}`;
            searchInput.value = `${loanIdFormatted} - ${memberName}`;
            hiddenInput.value = loanId;
            resultsDiv.style.display = 'none';

            // Show loan details
            detailsContent.innerHTML = `
                <table style="width: 100%; font-size: 14px;">
                    <tr><td><strong>Loan ID:</strong></td><td>${loanIdFormatted}</td></tr>
                    <tr><td><strong>Member:</strong></td><td>${memberName}</td></tr>
                    <tr><td><strong>Loan Amount:</strong></td><td>‚Çπ${amount.toLocaleString()}</td></tr>
                    <tr><td><strong>Outstanding:</strong></td><td>‚Çπ${outstanding.toLocaleString()}</td></tr>
                    <tr><td><strong>Loan Date:</strong></td><td>${new Date(loanDate).toLocaleDateString()}</td></tr>
                    <tr><td><strong>Status:</strong></td><td>${status}</td></tr>
                    <tr><td><strong>Interest:</strong></td><td>${rateInfo}</td></tr>
                </table>
                <p style="margin-top: 15px; color: #e74c3c; font-weight: bold;">
                    ‚ö†Ô∏è This will permanently delete the loan and all related repayments and interest accruals.
                </p>
            `;

            detailsDiv.style.display = 'block';
            deleteBtn.style.display = 'inline-block';
        }

        // Delete specific loan
        async function deleteSpecificLoan() {
            const loanId = document.getElementById('selectedLoanId').value;
            const searchInput = document.getElementById('loanSearchInput').value;

            if (!loanId) {
                showAlert('Please select a loan to delete', 'error');
                return;
            }

            // Multiple confirmations for safety
            if (!confirm(`‚ö†Ô∏è Are you absolutely sure you want to DELETE this loan?\n\n${searchInput}\n\nThis action cannot be undone!`)) {
                return;
            }

            if (!confirm(`üö® FINAL WARNING: This will permanently delete:\n\n‚Ä¢ The loan record\n‚Ä¢ All repayment history\n‚Ä¢ All interest accruals\n‚Ä¢ All related financial data\n\nType "DELETE LOAN" in the next prompt to confirm.`)) {
                return;
            }

            const confirmation = prompt('Type "DELETE LOAN" to confirm this permanent deletion:');
            if (confirmation !== 'DELETE LOAN') {
                showAlert('Operation cancelled - confirmation text did not match', 'warning');
                return;
            }

            try {
                showAlert('Deleting loan and all related data...', 'warning');

                // Delete in correct order (foreign key dependencies)
                
                // 1. Delete loan interest accruals
                const { error: accrualError } = await supabase
                    .from('loan_interest_accruals')
                    .delete()
                    .eq('loan_id', loanId);

                if (accrualError) throw accrualError;

                // 2. Delete loan repayments
                const { error: repaymentError } = await supabase
                    .from('loan_repayments')
                    .delete()
                    .eq('loan_id', loanId);

                if (repaymentError) throw repaymentError;

                // 3. Delete the loan itself
                const { error: loanError } = await supabase
                    .from('loans')
                    .delete()
                    .eq('id', loanId);

                if (loanError) throw loanError;

                showAlert(`‚úÖ Loan ${searchInput} and all related data deleted successfully!`, 'success');

                // Reset form
                document.getElementById('loanSearchInput').value = '';
                document.getElementById('selectedLoanId').value = '';
                document.getElementById('selectedLoanDetails').style.display = 'none';
                document.getElementById('deleteLoanBtn').style.display = 'none';

                // Refresh stats
                await refreshStats();

            } catch (error) {
                console.error('Error deleting loan:', error);
                showAlert('Error deleting loan: ' + error.message, 'error');
            }
        }

        // Initialize date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cutoffDate').value = today;

            // Show/hide date input based on selective operation
            document.getElementById('selectiveOperation').addEventListener('change', function() {
                const operation = this.value;
                const dateGroup = document.getElementById('dateGroup');
                
                if (operation.includes('old_')) {
                    dateGroup.style.display = 'block';
                } else {
                    dateGroup.style.display = 'none';
                }
            });
        });

        // Connect to database
        async function connectToDatabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                showAlert('Please enter both Supabase URL and key', 'error');
                return;
            }

            try {
                document.getElementById('connectionStatus').innerHTML = '<span class="loading"></span> Connecting...';
                
                supabase = window.supabase.createClient(url, key);
                
                // Test connection
                const { data, error } = await supabase.from('members').select('count').limit(1);
                
                if (error && error.code !== 'PGRST116') {
                    throw new Error(`Connection failed: ${error.message}`);
                }
                
                isConnected = true;
                document.getElementById('connectionStatus').innerHTML = '<span class="status-indicator status-connected"></span>Connected Successfully';
                document.getElementById('connectionResult').innerHTML = '<div class="alert alert-success">‚úÖ Successfully connected to database!</div>';
                
                // Show other sections
                document.getElementById('tableStats').style.display = 'block';
                document.getElementById('deletionOperations').style.display = 'block';
                
                // Initialize loan search
                initializeLoanSearch();
                
                // Load initial stats
                await refreshStats();
                
            } catch (error) {
                isConnected = false;
                document.getElementById('connectionStatus').innerHTML = '<span class="status-indicator status-disconnected"></span>Connection Failed';
                document.getElementById('connectionResult').innerHTML = `<div class="alert alert-error">‚ùå ${error.message}</div>`;
            }
        }

        // Refresh table statistics
        async function refreshStats() {
            if (!isConnected) {
                showAlert('Please connect to database first', 'error');
                return;
            }

            try {
                const tables = [
                    'members', 'member_pins', 'subscriptions', 'loans', 'loan_repayments',
                    'loan_interest_accruals', 'fixed_deposits', 'fd_interest_calculations',
                    'quarter_settings'
                ];

                let statsHTML = '<div class="deletion-grid">';
                
                for (const table of tables) {
                    try {
                        const { data, error, count } = await supabase
                            .from(table)
                            .select('*', { count: 'exact', head: true });
                        
                        const recordCount = error ? 'N/A' : (count || 0);
                        const statusClass = error ? 'status-disconnected' : 'status-connected';
                        
                        // Add special indicator for member_pins
                        const tableDisplay = table === 'member_pins' ? 'member_pins üîë' : table;
                        
                        statsHTML += `
                            <div class="stats-display">
                                <strong><span class="status-indicator ${statusClass}"></span>${tableDisplay}:</strong> ${recordCount} records
                            </div>
                        `;
                    } catch (e) {
                        const tableDisplay = table === 'member_pins' ? 'member_pins üîë' : table;
                        statsHTML += `
                            <div class="stats-display">
                                <strong><span class="status-indicator status-disconnected"></span>${tableDisplay}:</strong> Error
                            </div>
                        `;
                    }
                }
                
                statsHTML += '</div>';
                document.getElementById('statsContent').innerHTML = statsHTML;
                
            } catch (error) {
                showAlert('Error refreshing stats: ' + error.message, 'error');
            }
        }

        // Clear single table
        async function clearSingleTable() {
            const tableName = document.getElementById('tableSelect').value;
            
            if (!tableName) {
                showAlert('Please select a table to clear', 'error');
                return;
            }

            if (!confirm(`‚ö†Ô∏è Are you sure you want to DELETE ALL data from the "${tableName}" table?\n\nThis action cannot be undone!`)) {
                return;
            }

            if (!confirm(`üö® FINAL WARNING: This will permanently delete all records from "${tableName}".\n\nType "DELETE" in the next prompt to confirm.`)) {
                return;
            }

            const confirmation = prompt('Type "DELETE" to confirm this action:');
            if (confirmation !== 'DELETE') {
                showAlert('Operation cancelled - confirmation text did not match', 'warning');
                return;
            }

            try {
                showAlert('Deleting data from ' + tableName + '...', 'warning');

                // Handle cascading deletions
                if (tableName === 'members') {
                    await cascadeDeleteMembers();
                } else if (tableName === 'loans') {
                    await cascadeDeleteLoans();
                } else if (tableName === 'fixed_deposits') {
                    await cascadeDeleteFDs();
                } else {
                    // Simple table deletion (including member_pins)
                    const { error } = await supabase
                        .from(tableName)
                        .delete()
                        .neq('id', 0); // Delete all records
                    
                    if (error) throw error;
                }

                showAlert(`‚úÖ Successfully cleared all data from ${tableName}`, 'success');
                await refreshStats();

            } catch (error) {
                showAlert('Error clearing table: ' + error.message, 'error');
            }
        }

        // Cascade delete members and all related data (INCLUDING MEMBER PINS)
        async function cascadeDeleteMembers() {
            const operations = [
                'loan_interest_accruals',
                'loan_repayments', 
                'loans',
                'subscriptions',
                'fd_interest_calculations',
                'fixed_deposits',
                'member_pins',  // DELETE MEMBER PINS
                'members'
            ];

            for (const table of operations) {
                const { error } = await supabase.from(table).delete().neq('id', 0);
                if (error && error.code !== 'PGRST116') { // Ignore "not found" errors
                    console.warn(`Warning clearing ${table}:`, error.message);
                }
            }
        }

        // Cascade delete loans and related data
        async function cascadeDeleteLoans() {
            const operations = [
                'loan_interest_accruals',
                'loan_repayments',
                'loans'
            ];

            for (const table of operations) {
                const { error } = await supabase.from(table).delete().neq('id', 0);
                if (error) throw error;
            }
        }

        // Cascade delete FDs and related data
        async function cascadeDeleteFDs() {
            const operations = [
                'fd_interest_calculations',
                'fixed_deposits'
            ];

            for (const table of operations) {
                const { error } = await supabase.from(table).delete().neq('id', 0);
                if (error) throw error;
            }
        }

        // Perform selective deletion
        async function performSelectiveDeletion() {
            const operation = document.getElementById('selectiveOperation').value;
            const cutoffDate = document.getElementById('cutoffDate').value;

            if (!operation) {
                showAlert('Please select a deletion operation', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to perform: ${operation}?`)) {
                return;
            }

            try {
                let result;
                
                switch (operation) {
                    case 'old_subscriptions':
                        if (!cutoffDate) {
                            showAlert('Please select a cutoff date', 'error');
                            return;
                        }
                        result = await supabase
                            .from('subscriptions')
                            .delete()
                            .lt('payment_date', cutoffDate);
                        break;

                    case 'old_repayments':
                        if (!cutoffDate) {
                            showAlert('Please select a cutoff date', 'error');
                            return;
                        }
                        result = await supabase
                            .from('loan_repayments')
                            .delete()
                            .lt('payment_date', cutoffDate);
                        break;

                    case 'old_interest':
                        if (!cutoffDate) {
                            showAlert('Please select a cutoff date', 'error');
                            return;
                        }
                        result = await supabase
                            .from('loan_interest_accruals')
                            .delete()
                            .lt('accrual_date', cutoffDate);
                        break;

                    case 'closed_loans':
                        // Delete loans where outstanding_amount is 0 or null
                        result = await supabase
                            .from('loans')
                            .delete()
                            .or('outstanding_amount.eq.0,outstanding_amount.is.null');
                        break;

                    case 'orphaned_pins':
                        // Delete member PINs where the member no longer exists
                        const { data: orphanedPins } = await supabase
                            .from('member_pins')
                            .select('member_id')
                            .not('member_id', 'in', 
                                `(${await supabase.from('members').select('id').then(r => r.data?.map(m => m.id).join(',') || '0')})`
                            );
                        
                        if (orphanedPins && orphanedPins.length > 0) {
                            result = await supabase
                                .from('member_pins')
                                .delete()
                                .in('member_id', orphanedPins.map(p => p.member_id));
                        } else {
                            showAlert('No orphaned PINs found', 'success');
                            return;
                        }
                        break;

                    case 'test_data':
                        // Delete members with "test" in name (case insensitive) and their PINs
                        const { data: testMembers } = await supabase
                            .from('members')
                            .select('id')
                            .ilike('name', '%test%');
                        
                        if (testMembers && testMembers.length > 0) {
                            const memberIds = testMembers.map(m => m.id);
                            
                            // Delete related data first (including PINs)
                            await supabase.from('loan_interest_accruals').delete().in('loan_id', memberIds);
                            await supabase.from('loan_repayments').delete().in('loan_id', memberIds);
                            await supabase.from('loans').delete().in('member_id', memberIds);
                            await supabase.from('subscriptions').delete().in('member_id', memberIds);
                            await supabase.from('fd_interest_calculations').delete().in('fd_id', memberIds);
                            await supabase.from('fixed_deposits').delete().in('member_id', memberIds);
                            await supabase.from('member_pins').delete().in('member_id', memberIds); // DELETE PINS
                            await supabase.from('members').delete().in('id', memberIds);
                        }
                        result = { error: null };
                        break;

                    default:
                        throw new Error('Unknown operation');
                }

                if (result.error) throw result.error;

                showAlert(`‚úÖ Successfully completed: ${operation}`, 'success');
                await refreshStats();

            } catch (error) {
                showAlert('Error performing selective deletion: ' + error.message, 'error');
            }
        }

        // Reset financial data (keep member PINs)
        async function resetFinancialData() {
            if (!confirm('‚ö†Ô∏è This will reset ALL financial calculations while keeping member data and PINs.\n\nContinue?')) {
                return;
            }

            if (!confirm('üö® FINAL WARNING: This will delete:\n- All interest accruals\n- All FD interest calculations\n- All loan repayments\n\nMember PINs will be preserved.\n\nType "RESET" to confirm.')) {
                return;
            }

            const confirmation = prompt('Type "RESET" to confirm:');
            if (confirmation !== 'RESET') {
                showAlert('Operation cancelled', 'warning');
                return;
            }

            try {
                showAlert('Resetting financial data...', 'warning');

                // Delete in correct order (but preserve member_pins)
                await supabase.from('loan_interest_accruals').delete().neq('id', 0);
                await supabase.from('fd_interest_calculations').delete().neq('id', 0);
                await supabase.from('loan_repayments').delete().neq('id', 0);

                // Reset loan outstanding amounts to original amount
                const { data: loans } = await supabase.from('loans').select('id, amount');
                if (loans) {
                    for (const loan of loans) {
                        await supabase
                            .from('loans')
                            .update({ outstanding_amount: loan.amount, status: 'active' })
                            .eq('id', loan.id);
                    }
                }

                showAlert('‚úÖ Financial data reset completed successfully. Member PINs preserved.', 'success');
                await refreshStats();

            } catch (error) {
                showAlert('Error resetting financial data: ' + error.message, 'error');
            }
        }

        // Perform member actions (including PIN operations)
        async function performMemberAction() {
            const action = document.getElementById('memberAction').value;

            if (!action) {
                showAlert('Please select a member action', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to: ${action}?`)) {
                return;
            }

            try {
                let result;

                switch (action) {
                    case 'delete_suspended':
                        const { data: suspendedMembers } = await supabase
                            .from('members')
                            .select('id')
                            .eq('status', 'suspended');

                        if (suspendedMembers && suspendedMembers.length > 0) {
                            for (const member of suspendedMembers) {
                                await deleteMemberAndData(member.id);
                            }
                            showAlert(`‚úÖ Deleted ${suspendedMembers.length} suspended members and their data`, 'success');
                        } else {
                            showAlert('No suspended members found', 'success');
                        }
                        break;

                    case 'delete_inactive':
                        // Find members with no transactions
                        const { data: allMembers } = await supabase.from('members').select('id');
                        const inactiveMembers = [];

                        for (const member of allMembers) {
                            const [subs, loans, fds] = await Promise.all([
                                supabase.from('subscriptions').select('id').eq('member_id', member.id).limit(1),
                                supabase.from('loans').select('id').eq('member_id', member.id).limit(1),
                                supabase.from('fixed_deposits').select('id').eq('member_id', member.id).limit(1)
                            ]);

                            if ((!subs.data || subs.data.length === 0) && 
                                (!loans.data || loans.data.length === 0) && 
                                (!fds.data || fds.data.length === 0)) {
                                inactiveMembers.push(member.id);
                            }
                        }

                        for (const memberId of inactiveMembers) {
                            await deleteMemberAndData(memberId);
                        }
                        showAlert(`‚úÖ Deleted ${inactiveMembers.length} inactive members and their data`, 'success');
                        break;

                    case 'cleanup_duplicates':
                        // Find duplicate members by contact number
                        const { data: members } = await supabase
                            .from('members')
                            .select('id, name, contact')
                            .order('id');

                        const contactMap = new Map();
                        const duplicates = [];

                        members.forEach(member => {
                            if (contactMap.has(member.contact)) {
                                duplicates.push(member.id); // Keep first, mark rest as duplicates
                            } else {
                                contactMap.set(member.contact, member.id);
                            }
                        });

                        for (const memberId of duplicates) {
                            await deleteMemberAndData(memberId);
                        }
                        showAlert(`‚úÖ Removed ${duplicates.length} duplicate members and their data`, 'success');
                        break;

                    case 'reset_all_pins':
                        // Delete all custom PINs (members will use default PINs)
                        const { error: pinResetError } = await supabase
                            .from('member_pins')
                            .delete()
                            .neq('member_id', 0);

                        if (pinResetError && pinResetError.code !== 'PGRST116') {
                            throw pinResetError;
                        }
                        showAlert('‚úÖ All member PINs reset to default (last 4 digits of mobile)', 'success');
                        break;

                    case 'clear_custom_pins':
                        // Same as reset_all_pins - delete custom PINs
                        const { data: customPins } = await supabase
                            .from('member_pins')
                            .select('member_id');

                        const customPinCount = customPins ? customPins.length : 0;

                        const { error: clearPinsError } = await supabase
                            .from('member_pins')
                            .delete()
                            .neq('member_id', 0);

                        if (clearPinsError && clearPinsError.code !== 'PGRST116') {
                            throw clearPinsError;
                        }
                        showAlert(`‚úÖ Cleared ${customPinCount} custom PINs. Members will use default PINs.`, 'success');
                        break;

                    default:
                        throw new Error('Unknown member action');
                }

                await refreshStats();

            } catch (error) {
                showAlert('Error performing member action: ' + error.message, 'error');
            }
        }

        // Helper function to delete member and all related data (INCLUDING MEMBER PINS)
        async function deleteMemberAndData(memberId) {
            // Get loan IDs for this member
            const { data: memberLoans } = await supabase
                .from('loans')
                .select('id')
                .eq('member_id', memberId);

            const loanIds = memberLoans ? memberLoans.map(l => l.id) : [];

            // Get FD IDs for this member
            const { data: memberFDs } = await supabase
                .from('fixed_deposits')
                .select('id')
                .eq('member_id', memberId);

            const fdIds = memberFDs ? memberFDs.map(f => f.id) : [];

            // Delete in correct order (foreign key dependencies)
            if (loanIds.length > 0) {
                await supabase.from('loan_interest_accruals').delete().in('loan_id', loanIds);
                await supabase.from('loan_repayments').delete().in('loan_id', loanIds);
            }
            
            if (fdIds.length > 0) {
                await supabase.from('fd_interest_calculations').delete().in('fd_id', fdIds);
            }

            await supabase.from('subscriptions').delete().eq('member_id', memberId);
            await supabase.from('loans').delete().eq('member_id', memberId);
            await supabase.from('fixed_deposits').delete().eq('member_id', memberId);
            await supabase.from('member_pins').delete().eq('member_id', memberId); // DELETE MEMBER PIN
            await supabase.from('members').delete().eq('id', memberId);
        }

        // Clear all transaction data (keep members and PINs)
        async function clearAllTransactionData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL transaction data but keep member records and their PINs.\n\nContinue?')) {
                return;
            }

            if (!confirm('üö® FINAL WARNING: This will delete:\n- All subscriptions\n- All loans and repayments\n- All FDs and interest\n- All financial calculations\n\nMembers and their PINs will be preserved.\n\nType "CLEAR" to confirm.')) {
                return;
            }

            const confirmation = prompt('Type "CLEAR" to confirm:');
            if (confirmation !== 'CLEAR') {
                showAlert('Operation cancelled', 'warning');
                return;
            }

            try {
                showAlert('Clearing all transaction data...', 'warning');

                const operations = [
                    'loan_interest_accruals',
                    'loan_repayments',
                    'fd_interest_calculations',
                    'subscriptions',
                    'loans',
                    'fixed_deposits'
                    // NOTE: NOT deleting member_pins - they are preserved
                ];

                for (const table of operations) {
                    const { error } = await supabase.from(table).delete().neq('id', 0);
                    if (error) throw error;
                    showAlert(`‚úì Cleared ${table}`, 'success');
                }

                showAlert('‚úÖ All transaction data cleared successfully. Members and PINs preserved.', 'success');
                await refreshStats();

            } catch (error) {
                showAlert('Error clearing transaction data: ' + error.message, 'error');
            }
        }

        // Reset complete database (INCLUDING MEMBER PINS)
        async function resetCompleteDatabase() {
            if (!confirm('üö® EXTREME WARNING: This will delete EVERYTHING from your database!\n\nThis includes ALL members, transactions, settings, PINs, and data.\n\nContinue only if you want to start completely fresh.')) {
                return;
            }

            if (!confirm('üíÄ POINT OF NO RETURN: You are about to delete your ENTIRE database.\n\nAll data including member PINs will be permanently lost!\n\nType "DESTROY" to proceed.')) {
                return;
            }

            const confirmation = prompt('Type "DESTROY" to completely reset the database:');
            if (confirmation !== 'DESTROY') {
                showAlert('Operation cancelled', 'warning');
                return;
            }

            // Triple confirmation for safety
            if (!confirm('üî• ABSOLUTE FINAL WARNING üî•\n\nYou are about to DESTROY ALL DATA INCLUDING MEMBER PINS.\n\nClick OK only if you are 100% certain.')) {
                return;
            }

            try {
                showAlert('üíÄ Resetting complete database...', 'error');

                const allTables = [
                    'loan_interest_accruals',
                    'loan_repayments',
                    'fd_interest_calculations',
                    'subscriptions',
                    'loans',
                    'fixed_deposits',
                    'member_pins',  // DELETE MEMBER PINS TOO
                    'members',
                    'quarter_settings'
                ];

                for (const table of allTables) {
                    try {
                        const { error } = await supabase.from(table).delete().neq('id', 0);
                        if (error && error.code !== 'PGRST116') throw error;
                        showAlert(`üíÄ Destroyed ${table}`, 'error');
                    } catch (err) {
                        // Continue even if some tables fail
                        showAlert(`‚ö†Ô∏è Could not clear ${table}: ${err.message}`, 'warning');
                    }
                }

                // Reinitialize default quarter settings
                const defaultQuarters = [
                    { quarter_name: 'Q1', start_month: 4, end_month: 6 },
                    { quarter_name: 'Q2', start_month: 7, end_month: 9 },
                    { quarter_name: 'Q3', start_month: 10, end_month: 12 },
                    { quarter_name: 'Q4', start_month: 1, end_month: 3 }
                ];

                const { error: quarterError } = await supabase
                    .from('quarter_settings')
                    .insert(defaultQuarters);

                if (quarterError) {
                    showAlert('‚ö†Ô∏è Could not restore default quarter settings', 'warning');
                }

                showAlert('üíÄ DATABASE COMPLETELY RESET. All data including member PINs destroyed. Default quarter settings restored.', 'error');
                await refreshStats();

            } catch (error) {
                showAlert('Error during database reset: ' + error.message, 'error');
            }
        }

        // Show alert messages
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            const resultsArea = document.getElementById('resultsArea');
            resultsArea.insertBefore(alertDiv, resultsArea.firstChild);
            
            // Auto-remove after 10 seconds for success/warning, keep errors
            if (type !== 'error') {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 10000);
            }
            
            // Scroll to show the alert
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Export current data before deletion (including member_pins)
        async function exportDataBeforeDeletion() {
            if (!isConnected) {
                showAlert('Please connect to database first', 'error');
                return;
            }

            try {
                showAlert('Exporting data for backup...', 'warning');

                const tables = ['members', 'member_pins', 'subscriptions', 'loans', 'loan_repayments', 
                               'loan_interest_accruals', 'fixed_deposits', 'fd_interest_calculations', 
                               'quarter_settings'];
                
                const exportData = {};
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabase.from(table).select('*');
                        if (error && error.code !== 'PGRST116') {
                            console.warn(`Could not export ${table}:`, error.message);
                            exportData[table] = [];
                        } else {
                            exportData[table] = data || [];
                        }
                    } catch (err) {
                        exportData[table] = [];
                        console.warn(`Could not export ${table}:`, err.message);
                    }
                }

                // Add metadata
                exportData._metadata = {
                    exportDate: new Date().toISOString(),
                    exportedBy: 'Supabase Data Deletion Tool',
                    version: '1.1',
                    includesPins: true
                };

                // Download as JSON file
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `society_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showAlert('‚úÖ Data exported successfully as backup file (includes member PINs)', 'success');

            } catch (error) {
                showAlert('Error exporting data: ' + error.message, 'error');
            }
        }
        // Global variable to store restore data
        let restoreData = null;

        // Export full database as backup
        async function exportFullDatabaseBackup() {
            if (!isConnected) {
                showAlert('Please connect to database first', 'error');
                return;
            }

            try {
                showAlert('Creating full database backup...', 'warning');

                const tables = [
                    'members', 'member_pins', 'subscriptions', 'loans', 'loan_repayments',
                    'loan_interest_accruals', 'fixed_deposits', 'fd_interest_calculations',
                    'quarter_settings'
                ];

                const backupData = {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        exportedBy: 'Society Management System - Data Admin',
                        version: '2.0',
                        description: 'Complete database backup including all tables and member PINs',
                        totalTables: tables.length
                    },
                    tables: {}
                };

                let totalRecords = 0;

                for (const table of tables) {
                    try {
                        showAlert(`Exporting ${table}...`, 'warning');
                        
                        const { data, error } = await supabase.from(table).select('*');
                        
                        if (error && error.code !== 'PGRST116') {
                            console.warn(`Could not export ${table}:`, error.message);
                            backupData.tables[table] = {
                                data: [],
                                error: error.message,
                                recordCount: 0
                            };
                        } else {
                            const tableData = data || [];
                            backupData.tables[table] = {
                                data: tableData,
                                recordCount: tableData.length,
                                exportedAt: new Date().toISOString()
                            };
                            totalRecords += tableData.length;
                        }
                    } catch (err) {
                        console.warn(`Could not export ${table}:`, err.message);
                        backupData.tables[table] = {
                            data: [],
                            error: err.message,
                            recordCount: 0
                        };
                    }
                }

                backupData.metadata.totalRecords = totalRecords;
                backupData.metadata.exportCompleted = new Date().toISOString();

                // Download as JSON file
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `society_database_backup_${new Date().toISOString().split('T')[0]}_${new Date().getTime()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showAlert(`‚úÖ Database backup completed! ${totalRecords} records exported from ${tables.length} tables.`, 'success');

            } catch (error) {
                console.error('Error creating database backup:', error);
                showAlert('Error creating database backup: ' + error.message, 'error');
            }
        }

        // Export members to Excel
// Update exportMembersToExcel function
async function exportMembersToExcel() {
    if (!isConnected) {
        showAlert('Please connect to database first', 'error');
        return;
    }

    try {
        showAlert('Exporting members to Excel...', 'warning');

        // Get members data with subscription amounts
        const { data: members, error: membersError } = await supabase
            .from('members')
            .select('*')
            .order('id');

        if (membersError) throw membersError;

        if (!members || members.length === 0) {
            showAlert('No members found to export', 'warning');
            return;
        }

        // Get member PINs
        const { data: memberPins, error: pinsError } = await supabase
            .from('member_pins')
            .select('member_id, pin');

        if (pinsError && pinsError.code !== 'PGRST116') {
            console.warn('Could not fetch member PINs:', pinsError.message);
        }

        // Create PIN lookup map
        const pinMap = {};
        if (memberPins) {
            memberPins.forEach(pin => {
                pinMap[pin.member_id] = pin.pin;
            });
        }

        // Prepare Excel data with subscription amounts
        const excelData = members.map(member => {
            const defaultPin = member.contact ? member.contact.slice(-4) : 'N/A';
            const customPin = pinMap[member.id];
            const currentPin = customPin || defaultPin;
            const pinType = customPin ? 'Custom' : 'Default';
            const subscriptionAmount = member.subscription_amount > 0 ? 
                parseFloat(member.subscription_amount).toFixed(2) : '0.00';

            return {
                'Member ID': `MS${String(member.id).padStart(4, '0')}`,
                'Name': member.name || '',
                'Contact Number': member.contact || '',
                'Join Date': member.join_date ? new Date(member.join_date).toLocaleDateString() : '',
                'Monthly Subscription': `‚Çπ${subscriptionAmount}`,
                'Status': member.status || 'active',
                'Current PIN': currentPin,
                'PIN Type': pinType,
                'Default PIN': defaultPin,
                'Created At': member.created_at ? new Date(member.created_at).toLocaleDateString() : '',
                'Updated At': member.updated_at ? new Date(member.updated_at).toLocaleDateString() : ''
            };
        });

        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);

        // Set column widths
        const colWidths = [
            { width: 12 }, // Member ID
            { width: 25 }, // Name
            { width: 15 }, // Contact
            { width: 12 }, // Join Date
            { width: 15 }, // Monthly Subscription
            { width: 10 }, // Status
            { width: 12 }, // Current PIN
            { width: 10 }, // PIN Type
            { width: 12 }, // Default PIN
            { width: 12 }, // Created At
            { width: 12 }  // Updated At
        ];
        ws['!cols'] = colWidths;

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Members');

        // Add summary sheet with subscription info
        const totalSubscriptionAmount = members.reduce((sum, member) => 
            sum + (parseFloat(member.subscription_amount) || 0), 0);
        const membersWithCustomAmounts = members.filter(member => 
            member.subscription_amount > 0).length;

        const summaryData = [
            { 'Summary': 'Total Members', 'Value': members.length },
            { 'Summary': 'Active Members', 'Value': members.filter(m => m.status === 'active').length },
            { 'Summary': 'Suspended Members', 'Value': members.filter(m => m.status === 'suspended').length },
            { 'Summary': 'Members with Custom Subscription', 'Value': membersWithCustomAmounts },
            { 'Summary': 'Members with Variable Subscription', 'Value': members.length - membersWithCustomAmounts },
            { 'Summary': 'Total Monthly Subscription Value', 'Value': `‚Çπ${totalSubscriptionAmount.toFixed(2)}` },
            { 'Summary': 'Average Subscription Amount', 'Value': membersWithCustomAmounts > 0 ? `‚Çπ${(totalSubscriptionAmount / membersWithCustomAmounts).toFixed(2)}` : '‚Çπ0.00' },
            { 'Summary': 'Members with Custom PINs', 'Value': Object.keys(pinMap).length },
            { 'Summary': 'Export Date', 'Value': new Date().toLocaleString() },
            { 'Summary': 'Exported By', 'Value': 'Society Management System' }
        ];

        const summaryWs = XLSX.utils.json_to_sheet(summaryData);
        summaryWs['!cols'] = [{ width: 30 }, { width: 25 }];
        XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');

        // Generate filename
        const fileName = `society_members_${new Date().toISOString().split('T')[0]}_${new Date().getTime()}.xlsx`;

        // Save file
        XLSX.writeFile(wb, fileName);

        showAlert(`‚úÖ Members exported to Excel successfully! ${members.length} members exported with subscription amounts and PIN information.`, 'success');

    } catch (error) {
        console.error('Error exporting members to Excel:', error);
        showAlert('Error exporting members to Excel: ' + error.message, 'error');
    }
}

        // Handle restore file selection
        function handleRestoreFile(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('restorePreview').style.display = 'none';
                document.getElementById('restoreBtn').style.display = 'none';
                restoreData = null;
                return;
            }

            if (!file.name.toLowerCase().endsWith('.json')) {
                showAlert('Please select a valid JSON backup file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate backup file structure
                    if (!data.metadata || !data.tables) {
                        throw new Error('Invalid backup file format');
                    }

                    restoreData = data;
                    displayRestorePreview(data);
                    document.getElementById('restorePreview').style.display = 'block';
                    document.getElementById('restoreBtn').style.display = 'inline-block';

                } catch (error) {
                    showAlert('Error reading backup file: ' + error.message, 'error');
                    restoreData = null;
                    document.getElementById('restorePreview').style.display = 'none';
                    document.getElementById('restoreBtn').style.display = 'none';
                }
            };

            reader.readAsText(file);
        }

        // Display restore preview
        function displayRestorePreview(data) {
            const metadata = data.metadata;
            const tables = data.tables;
            
            let totalRecords = 0;
            let tablesList = '';
            
            Object.keys(tables).forEach(tableName => {
                const table = tables[tableName];
                const recordCount = table.recordCount || 0;
                totalRecords += recordCount;
                tablesList += `<li>${tableName}: ${recordCount} records</li>`;
            });

            const previewHTML = `
                <div class="confirmation-box">
                    <h4>üìÇ Backup File Information</h4>
                    <p><strong>Export Date:</strong> ${new Date(metadata.exportDate).toLocaleString()}</p>
                    <p><strong>Version:</strong> ${metadata.version || 'Unknown'}</p>
                    <p><strong>Total Records:</strong> ${totalRecords}</p>
                    <p><strong>Tables Found:</strong> ${Object.keys(tables).length}</p>
                    
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; font-weight: bold;">üìã Table Details</summary>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${tablesList}
                        </ul>
                    </details>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                        <strong>‚ö†Ô∏è Warning:</strong> Restore will replace ALL current data with backup data.
                    </div>
                </div>
            `;

            document.getElementById('restoreFileInfo').innerHTML = previewHTML;
        }

        // Restore database from backup
        async function restoreDatabase() {
            if (!restoreData) {
                showAlert('Please select a backup file first', 'error');
                return;
            }

            if (!isConnected) {
                showAlert('Please connect to database first', 'error');
                return;
            }

            // Multiple confirmations for safety
            if (!confirm('‚ö†Ô∏è DANGER: This will REPLACE ALL current data with backup data.\n\nAll existing data will be permanently lost!\n\nContinue?')) {
                return;
            }

            if (!confirm('üö® FINAL WARNING: You are about to restore the database.\n\nType "RESTORE DATABASE" in the next prompt to confirm.')) {
                return;
            }

            const confirmation = prompt('Type "RESTORE DATABASE" to confirm this action:');
            if (confirmation !== 'RESTORE DATABASE') {
                showAlert('Operation cancelled - confirmation text did not match', 'warning');
                return;
            }

            try {
                showAlert('Starting database restore...', 'warning');

                const tables = restoreData.tables;
                let totalRestored = 0;

                // Clear existing data first (in correct order)
                const deleteOrder = [
                    'loan_interest_accruals',
                    'loan_repayments',
                    'fd_interest_calculations',
                    'subscriptions',
                    'loans',
                    'fixed_deposits',
                    'member_pins',
                    'members',
                    'quarter_settings'
                ];

                showAlert('Clearing existing data...', 'warning');
                for (const table of deleteOrder) {
                    try {
                        await supabase.from(table).delete().neq('id', 0);
                        showAlert(`‚úì Cleared ${table}`, 'warning');
                    } catch (error) {
                        console.warn(`Could not clear ${table}:`, error.message);
                    }
                }

                // Restore data (in correct order for foreign keys)
                const restoreOrder = [
                    'quarter_settings',
                    'members',
                    'member_pins',
                    'fixed_deposits',
                    'loans',
                    'subscriptions',
                    'loan_repayments',
                    'loan_interest_accruals',
                    'fd_interest_calculations'
                ];

                for (const tableName of restoreOrder) {
                    if (tables[tableName] && tables[tableName].data && tables[tableName].data.length > 0) {
                        try {
                            showAlert(`Restoring ${tableName}...`, 'warning');
                            
                            const tableData = tables[tableName].data;
                            
                            // Insert data in batches to avoid timeout
                            const batchSize = 100;
                            for (let i = 0; i < tableData.length; i += batchSize) {
                                const batch = tableData.slice(i, i + batchSize);
                                const { error } = await supabase.from(tableName).insert(batch);
                                if (error) throw error;
                            }
                            
                            totalRestored += tableData.length;
                            showAlert(`‚úì Restored ${tableData.length} records to ${tableName}`, 'success');
                            
                        } catch (error) {
                            console.error(`Error restoring ${tableName}:`, error);
                            showAlert(`‚ùå Error restoring ${tableName}: ${error.message}`, 'error');
                        }
                    }
                }

                showAlert(`‚úÖ Database restore completed! ${totalRestored} total records restored.`, 'success');
                
                // Reset form
                document.getElementById('restoreFile').value = '';
                document.getElementById('restorePreview').style.display = 'none';
                document.getElementById('restoreBtn').style.display = 'none';
                restoreData = null;

                // Refresh stats
                await refreshStats();

            } catch (error) {
                console.error('Error during database restore:', error);
                showAlert('Error during database restore: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>