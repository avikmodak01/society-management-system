<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Management Portal</title>
    
    <!-- External JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js"></script>
    <script src="security-utils.js"></script>
    
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .content {
            padding: 30px;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            text-align: center;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            font-size: 1.4em;
        }

        /* Form Styles */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Search Styles */
        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 18px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: white;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .search-result-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .member-id {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }

        .member-name {
            font-weight: 600;
            color: #2c3e50;
            margin: 5px 0;
        }

        .member-details {
            font-size: 12px;
            color: #666;
        }

        /* Button Styles */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Member Card Styles */
        .member-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .member-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .member-card.suspended {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .member-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        .subscription-amount {
            color: #27ae60;
            font-size: 18px;
        }

        /* Status Badge */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-suspended {
            background: #f8d7da;
            color: #721c24;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin: 2px;
        }

        /* Alert Styles */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stats-card h4 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stats-card .number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stats-card small {
            opacity: 0.8;
            font-size: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 30px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tab-navigation {
                flex-direction: column;
                gap: 5px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .member-info {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .modal-body {
                padding: 20px;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .empty-state p {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        /* Bulk Selection */
        .bulk-selection {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .bulk-selection.active {
            display: block;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .member-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        /* Additional modal styles for subscription modals */
        #individualSubscriptionModal,
        #subscriptionHistoryModal {
            z-index: 3000;
        }

        #individualSubscriptionModal .modal-content,
        #subscriptionHistoryModal .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        .subscription-history-item {
            padding: 12px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .subscription-history-item:hover {
            background: #e8f4fd;
        }
        /* Report table styles */
        #subscriptionReportTable {
            font-size: 14px;
            min-width: 100%;
        }

        #subscriptionReportTable th:first-child,
        #subscriptionReportTable td:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        #subscriptionReportTable thead th {
            position: sticky;
            top: 0;
            z-index: 12;
        }

        #reportTableContainer {
            max-height: 600px;
            overflow: auto;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
        }

        .report-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        /* Progress indicator for large reports */
.report-progress {
    background: #e8f4fd;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    text-align: center;
    border-left: 4px solid #3498db;
}

.report-progress .loading {
    margin-right: 10px;
}

/* Improved table performance for large datasets */
#subscriptionReportTable {
    table-layout: fixed;
    width: 100%;
}

#subscriptionReportTable th,
#subscriptionReportTable td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

#subscriptionReportTable th:first-child,
#subscriptionReportTable td:first-child {
    width: 200px;
    white-space: normal;
}



/* Report table styles - Add to your <style> section */
#subscriptionReportTable {
    font-size: 14px;
    min-width: 100%;
    table-layout: auto;
}

#subscriptionReportTable th:first-child,
#subscriptionReportTable td:first-child {
    position: sticky;
    left: 0;
    z-index: 10;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    min-width: 200px;
    max-width: 200px;
}

#subscriptionReportTable thead th {
    position: sticky;
    top: 0;
    z-index: 12;
}

#reportTableContainer {
    max-height: 600px;
    overflow: auto;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
}

#subscriptionReportTable th,
#subscriptionReportTable td {
    padding: 10px;
    vertical-align: top;
}

#subscriptionReportTable tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}

#subscriptionReportTable tbody tr:hover {
    background-color: #e8f4fd;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="logout-btn" onclick="adminLogout()" title="Logout from admin panel">
                üö™ Logout
            </button>
            <h1>üë• Member Management Portal</h1>
            <p>Comprehensive member and subscription management system</p>
        </div>

        <div class="content">
            <!-- Tab Navigation -->
        <div class="tab-navigation">
        <button class="tab-btn active" onclick="showTab('search')">
            üîç Search Members
        </button>
        <button class="tab-btn" onclick="showTab('add')">
            ‚ûï Add Member
        </button>
        <button class="tab-btn" onclick="showTab('import')">
            üìä Import Excel
        </button>
        <button class="tab-btn" onclick="showTab('bulk-subscription')">
            üí∞ Bulk Subscriptions
        </button>
        <button class="tab-btn" onclick="showTab('view-all')">
            üìã View All Members
        </button>
        <button class="tab-btn" onclick="showTab('reports')">
            üìà Reports
        </button>
        <button class="tab-btn" onclick="showTab('statistics')">
            üìä Statistics
        </button>
    </div>

            <!-- Search Members Tab -->
            <div id="search" class="tab-content active">
                <div class="card">
                    <h3>üîç Search Members</h3>
                    <div class="search-container">
                        <input type="text" id="memberSearch" class="search-input" 
                               placeholder="Search by member name, contact number, or member ID..." 
                               autocomplete="off">
                        <div id="searchResults" class="search-results"></div>
                    </div>
                    <div id="selectedMemberDetails"></div>
                </div>
            </div>

            <!-- Add Member Tab -->
            <div id="add" class="tab-content">
                <div class="card">
                    <h3>‚ûï Add New Member</h3>
                    <form id="addMemberForm">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="memberName">Member Name *</label>
                                <input type="text" id="memberName" required placeholder="Enter full name">
                            </div>
                            <div class="form-col">
                                <label for="memberContact">Contact Number *</label>
                                <input type="tel" id="memberContact" required placeholder="Enter 10-digit mobile number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="joinDate">Join Date *</label>
                                <input type="date" id="joinDate" required>
                            </div>
                            <div class="form-col">
                                <label for="subscriptionAmount">Monthly Subscription Amount *</label>
                                <input type="number" id="subscriptionAmount" required min="0" step="0.01" 
                                       placeholder="Enter default monthly subscription">
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <strong>üí° Member Information:</strong><br>
                            ‚Ä¢ Member ID will be auto-generated (MS0001, MS0002, etc.)<br>
                            ‚Ä¢ Subscription amount will be used as default for bulk operations<br>
                            ‚Ä¢ Set subscription to 0 for variable amounts<br>
                            ‚Ä¢ Contact number must be unique in the system
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            ‚ûï Add Member
                        </button>
                    </form>
                </div>
            </div>

            <!-- Import Excel Tab -->
            <div id="import" class="tab-content">
                <div class="card">
                    <h3>üìä Import Members from Excel</h3>
                    <p><em>Import member details from Excel file. Required columns: Name (Column A), Contact (Column B), Subscription Amount (Column C - optional)</em></p>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="excelFile">Select Excel File (.xlsx, .xls)</label>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelImport(event)">
                        </div>
                        <div class="form-col" style="display: flex; align-items: flex-end;">
                            <button type="button" class="btn btn-success" onclick="processExcelImport()" id="processImportBtn" style="display: none;">
                                üìä Process Import
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üìã Excel Import Instructions:</strong><br>
                        ‚Ä¢ <strong>Column A:</strong> Member Name (Required)<br>
                        ‚Ä¢ <strong>Column B:</strong> Contact Number - 10 digits (Required)<br>
                        ‚Ä¢ <strong>Column C:</strong> Monthly Subscription Amount (Optional - defaults to 0 for variable)<br>
                        ‚Ä¢ First row can be headers and will be automatically detected<br>
                        ‚Ä¢ All imported members will be set as 'Active' status<br>
                        ‚Ä¢ Duplicate contact numbers will be skipped with error report
                    </div>
                    
                    <div id="importPreview"></div>
                </div>
            </div>

            <!-- Bulk Subscriptions Tab -->
            <div id="bulk-subscription" class="tab-content">
                <div class="card">
                    <h3>üí∞ Bulk Subscription Management</h3>
                    
                    <!-- Quick Bulk for All Members -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4>üìÖ Add Monthly Subscription for All Active Members</h4>
                        <form id="bulkAllForm">
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="bulkMonth">Select Month *</label>
                                    <input type="month" id="bulkMonth" required>
                                </div>
                                <div class="form-col">
                                    <label for="bulkPaymentDate">Payment Date *</label>
                                    <input type="date" id="bulkPaymentDate" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="bulkDefaultAmount">Default Amount (for members without preset amount) *</label>
                                    <input type="number" id="bulkDefaultAmount" required min="0" step="0.01" 
                                           placeholder="Amount for members with variable subscription">
                                </div>
                                <div class="form-col" style="display: flex; align-items: flex-end;">
                                    <button type="submit" class="btn btn-success">
                                        üí∞ Add to All Active Members
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Selective Bulk Subscription -->
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
                        <h4>üéØ Selective Bulk Subscription</h4>
                        <p>Search and select specific members for bulk subscription entry</p>
                        
                        <div class="form-group">
                            <label for="selectiveSearch">Search Members for Bulk Selection</label>
                            <input type="text" id="selectiveSearch" placeholder="Search members to select for bulk subscription..." 
                                   class="search-input">
                        </div>
                        
                        <div id="selectiveBulkContainer" style="display: none;">
                            <div class="bulk-selection" id="bulkSelectionBar">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span id="selectedCount">0 members selected</span>
                                    <div>
                                        <button type="button" class="btn btn-warning btn-small" onclick="clearBulkSelection()">
                                            Clear Selection
                                        </button>
                                        <button type="button" class="btn btn-success btn-small" onclick="processBulkSelection()">
                                            Add Subscriptions for Selected
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="selectiveMembersList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View All Members Tab -->
            <div id="view-all" class="tab-content">
                <div class="card">
                    <h3>üìã All Members</h3>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-col">
                            <label for="statusFilter">Filter by Status</label>
                            <select id="statusFilter" onchange="filterMembers()">
                                <option value="">All Members</option>
                                <option value="active">Active Only</option>
                                <option value="suspended">Suspended Only</option>
                            </select>
                        </div>
                        <div class="form-col" style="display: flex; align-items: flex-end; gap: 10px;">
                            <button class="btn btn-primary" onclick="loadAllMembers()">
                                üîÑ Refresh List
                            </button>
                            <button class="btn btn-success" onclick="exportMembersToExcel()">
                                üìä Export Excel
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="allMembersTable">
                            <thead>
                                <tr>
                                    <th>Member ID</th>
                                    <th>Name</th>
                                    <th>Contact</th>
                                    <th>Join Date</th>
                                    <th>Subscription</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px;">
                                        <div class="loading"></div> Loading members...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <div class="card">
                    <h3>üìà Subscription Collection Reports</h3>
                    
                    <!-- Report Filters -->
                    <div class="form-row" style="margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <div class="form-col">
                            <label for="reportFromMonth">From Month</label>
                            <input type="month" id="reportFromMonth">
                        </div>
                        <div class="form-col">
                            <label for="reportToMonth">To Month</label>
                            <input type="month" id="reportToMonth">
                        </div>
                        <div class="form-col">
                            <label for="reportMemberFilter">Member Filter</label>
                            <select id="reportMemberFilter">
                                <option value="">All Members</option>
                                <option value="active">Active Members Only</option>
                                <option value="with-payments">Members with Payments Only</option>
                            </select>
                        </div>
                        <div class="form-col" style="display: flex; align-items: flex-end; gap: 10px;">
                            <button class="btn btn-primary" onclick="generateSubscriptionReport()">
                                üìä Generate Report
                            </button>
                            <button class="btn btn-success" onclick="exportReportToExcel()" id="exportReportBtn" style="display: none;">
                                üìÑ Export Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Report Summary Cards -->
                    <div id="reportSummary" style="display: none;">
                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stats-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                                <h4>Total Collection</h4>
                                <div class="number" id="reportTotalAmount">‚Çπ0</div>
                                <small id="reportPeriodText">For selected period</small>
                            </div>
                            <div class="stats-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                                <h4>Active Members</h4>
                                <div class="number" id="reportMemberCount">0</div>
                                <small>Members with payments</small>
                            </div>
                            <div class="stats-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                                <h4>Average per Member</h4>
                                <div class="number" id="reportAvgPerMember">‚Çπ0</div>
                                <small>Per member average</small>
                            </div>
                            <div class="stats-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                                <h4>Months Covered</h4>
                                <div class="number" id="reportMonthCount">0</div>
                                <small>Reporting period</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Report Table -->
                    <div id="reportTableContainer" style="display: none;">
                        <div class="table-container">
                            <table id="subscriptionReportTable">
                                <thead id="reportTableHead">
                                    <!-- Dynamic headers will be inserted here -->
                                </thead>
                                <tbody id="reportTableBody">
                                    <!-- Dynamic data will be inserted here -->
                                </tbody>
                                <tfoot id="reportTableFoot">
                                    <!-- Grand totals will be inserted here -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <!-- No Data Message -->
                    <div id="noReportData" style="display: none;">
                        <div class="empty-state">
                            <h3>No Data Found</h3>
                            <p>No subscription payments found for the selected criteria.</p>
                            <button class="btn btn-primary" onclick="showTab('bulk-subscription')">
                                üí∞ Add Subscriptions
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="statistics" class="tab-content">
                <div class="stats-grid" id="statisticsGrid">
                    <div class="stats-card">
                        <h4>Total Members</h4>
                        <div class="number" id="totalMembers">0</div>
                        <small>All registered members</small>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                        <h4>Active Members</h4>
                        <div class="number" id="activeMembers">0</div>
                        <small>Currently active</small>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <h4>Suspended Members</h4>
                        <div class="number" id="suspendedMembers">0</div>
                        <small>Currently suspended</small>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                        <h4>Total Subscription Value</h4>
                        <div class="number" id="totalSubscriptionValue">‚Çπ0</div>
                        <small>Monthly collection potential</small>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üìà Subscription Analysis</h3>
                    <div id="subscriptionAnalysis">
                        <div class="loading"></div> Loading subscription analysis...
                    </div>
                </div>
                
                <div class="card">
                    <h3>üîÑ Recent Activity</h3>
                    <div id="recentActivity">
                        <div class="loading"></div> Loading recent activity...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Edit Member Details</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editMemberForm">
                    <input type="hidden" id="editMemberId">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="editMemberName">Member Name *</label>
                            <input type="text" id="editMemberName" required>
                        </div>
                        <div class="form-col">
                            <label for="editMemberContact">Contact Number *</label>
                            <input type="tel" id="editMemberContact" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="editSubscriptionAmount">Monthly Subscription Amount *</label>
                            <input type="number" id="editSubscriptionAmount" required min="0" step="0.01">
                        </div>
                        <div class="form-col">
                            <label for="editMemberStatus">Status</label>
                            <select id="editMemberStatus" required>
                                <option value="active">Active</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <button type="submit" class="btn btn-primary">
                                üíæ Update Member
                            </button>
                        </div>
                        <div class="form-col">
                            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Selection Modal -->
    <div id="bulkSelectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ Bulk Subscription for Selected Members</h3>
                <span class="close" onclick="closeBulkModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="bulkSelectedForm">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="selectedBulkMonth">Select Month *</label>
                            <input type="month" id="selectedBulkMonth" required>
                        </div>
                        <div class="form-col">
                            <label for="selectedBulkDate">Payment Date *</label>
                            <input type="date" id="selectedBulkDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="selectedBulkAmount">Default Amount (for members without preset amount) *</label>
                            <input type="number" id="selectedBulkAmount" required min="0" step="0.01">
                        </div>
                        <div class="form-col">
                            <!-- Empty for layout -->
                        </div>
                    </div>
                    
                    <div id="selectedMembersSummary" class="alert alert-info">
                        <strong>Selected Members:</strong> <span id="selectedMembersCount">0</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <button type="submit" class="btn btn-success">
                                üí∞ Add Subscriptions
                            </button>
                        </div>
                        <div class="form-col">
                            <button type="button" class="btn btn-secondary" onclick="closeBulkModal()">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // SECURE CONFIGURATION
        let supabase;
        let allMembers = [];
        let selectedMembers = new Set();
        let appConfig;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Load secure configuration
                appConfig = await window.SecureConfig.loadConfig();
                
                if (!window.SecureConfig.validateConfig()) {
                    throw new Error('Invalid configuration loaded');
                }
                
                if (typeof window.supabase !== 'undefined') {
                    // Initialize Supabase with secure config
                    const supabaseConfig = window.SecureConfig.getSupabaseConfig();
                    supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey);
                    
                    console.log('‚úÖ Member Management Portal initialized securely');
                    
                    setupEventListeners();
                    loadInitialData();
                } else {
                    throw new Error('Supabase library not loaded');
                }
            } catch (error) {
                console.error('‚ùå Member Management initialization failed:', error);
                showAlert('System initialization failed. Please refresh the page.', 'error');
            }
        });

        // Excel import functions
function handleExcelImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const arrayBuffer = e.target.result;
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            // Get the first sheet
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Filter out empty rows and process data
            const memberData = [];
            let startRow = 0;
            
            // Check if first row has headers
            if (jsonData.length > 0 && jsonData[0] && 
                (String(jsonData[0][0]).toLowerCase().includes('name') || 
                 String(jsonData[0][1]).toLowerCase().includes('contact'))) {
                startRow = 1; // Skip header row
            }
            
            for (let i = startRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row[0] && row[1]) { // Name and contact both present
                    const name = String(row[0]).trim();
                    const contact = String(row[1]).trim();
                    const subscriptionAmount = row[2] ? parseFloat(row[2]) : 0;
                    
                    if (name && contact) {
                        memberData.push({
                            row: i + 1,
                            name: name,
                            contact: contact,
                            subscriptionAmount: subscriptionAmount || 0,
                            status: 'Ready'
                        });
                    }
                }
            }
            
            if (memberData.length === 0) {
                showAlert('No valid member data found in Excel file. Please ensure Column A has names and Column B has contact numbers.', 'error');
                return;
            }
            
            // Validate contact numbers and check for duplicates
            validateImportData(memberData);
            
        } catch (error) {
            console.error('Excel import error:', error);
            showAlert('Error reading Excel file: ' + error.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

async function validateImportData(memberData) {
    try {
        // Get existing members for duplicate checking
        const { data: existingMembers, error } = await supabase
            .from('members')
            .select('name, contact');
        
        if (error) throw error;
        
        // Validate each member
        memberData.forEach(member => {
            // Check for duplicate contacts in existing database
            const duplicateContact = existingMembers?.find(existing => 
                existing.contact === member.contact
            );
            
            if (duplicateContact) {
                member.status = 'Duplicate Contact';
                member.error = `Contact already exists for: ${duplicateContact.name}`;
                return;
            }
            
            // Check for duplicate contacts within import data
            const duplicateInImport = memberData.find((other, index) => 
                other !== member && other.contact === member.contact
            );
            
            if (duplicateInImport) {
                member.status = 'Duplicate in Import';
                member.error = 'Contact appears multiple times in import data';
                return;
            }
            
            // Validate contact number format
            if (!/^\d{10}$/.test(member.contact.replace(/\D/g, ''))) {
                member.status = 'Invalid Contact';
                member.error = 'Contact should be exactly 10 digits';
                return;
            }
            
            // Validate subscription amount
            if (member.subscriptionAmount < 0) {
                member.status = 'Invalid Subscription';
                member.error = 'Subscription amount cannot be negative';
                return;
            }
            
            member.status = 'Ready';
        });
        
        window.excelImportData = memberData;
        displayImportPreview();
        
    } catch (error) {
        console.error('Validation error:', error);
        showAlert('Error validating import data: ' + error.message, 'error');
    }
}

function displayImportPreview() {
    const excelImportData = window.excelImportData;
    if (!excelImportData) return;
    
    const validCount = excelImportData.filter(m => m.status === 'Ready').length;
    const errorCount = excelImportData.length - validCount;
    
    let previewHTML = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h4>üìä Import Preview</h4>
            <p><strong>Total Rows:</strong> ${excelImportData.length} | <strong>Valid:</strong> ${validCount} | <strong>Errors:</strong> ${errorCount}</p>
        </div>
        
        <div class="table-container">
            <table style="font-size: 14px;">
                <thead>
                    <tr style="background: #34495e; color: white;">
                        <th>Row</th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Subscription</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    excelImportData.forEach(member => {
        const statusColor = member.status === 'Ready' ? '#27ae60' : '#e74c3c';
        const statusText = member.error || member.status;
        const subscriptionDisplay = member.subscriptionAmount > 0 ? 
            `‚Çπ${member.subscriptionAmount.toFixed(2)}` : 'Variable';
        
        previewHTML += `
            <tr>
                <td>${member.row}</td>
                <td>${member.name}</td>
                <td>${member.contact}</td>
                <td>${subscriptionDisplay}</td>
                <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
            </tr>
        `;
    });
    
    previewHTML += '</tbody></table></div>';
    
    document.getElementById('importPreview').innerHTML = previewHTML;
    
    if (validCount > 0) {
        document.getElementById('processImportBtn').style.display = 'inline-block';
    } else {
        document.getElementById('processImportBtn').style.display = 'none';
    }
}

async function processExcelImport() {
    const excelImportData = window.excelImportData;
    if (!excelImportData) {
        showAlert('No import data available', 'error');
        return;
    }
    
    try {
        const validMembers = excelImportData.filter(m => m.status === 'Ready');
        
        if (validMembers.length === 0) {
            showAlert('No valid members to import', 'error');
            return;
        }
        
        if (!confirm(`Import ${validMembers.length} members?\n\nThis action cannot be undone.`)) {
            return;
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        const membersToInsert = validMembers.map(member => ({
            name: member.name,
            contact: member.contact,
            join_date: today,
            subscription_amount: member.subscriptionAmount,
            status: 'active'
        }));
        
        const { data, error } = await supabase
            .from('members')
            .insert(membersToInsert)
            .select();
        
        if (error) throw error;
        
        showAlert(`‚úÖ Successfully imported ${validMembers.length} members!\n\nFirst Member ID: MS${String(data[0].id).padStart(4, '0')}\nLast Member ID: MS${String(data[data.length-1].id).padStart(4, '0')}`, 'success');
        
        // Clear import data and refresh
        window.excelImportData = null;
        document.getElementById('excelFile').value = '';
        document.getElementById('importPreview').innerHTML = '';
        document.getElementById('processImportBtn').style.display = 'none';
        
        await Promise.all([
            loadAllMembers(),
            loadStatistics()
        ]);
        
    } catch (error) {
        console.error('Import processing error:', error);
        showAlert('Error processing import: ' + error.message, 'error');
    }
}


// Reports functionality
let reportData = null;

// Set default report dates (last 6 months)
function setDefaultReportDates() {
    const currentDate = new Date();
    const currentMonth = currentDate.toISOString().slice(0, 7);
    
    // Set to month 6 months ago
    const fromDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 5, 1);
    const fromMonth = fromDate.toISOString().slice(0, 7);
    
    document.getElementById('reportFromMonth').value = fromMonth;
    document.getElementById('reportToMonth').value = currentMonth;
}


// Generate subscription collection report
async function generateSubscriptionReport() {
    const fromMonth = document.getElementById('reportFromMonth').value;
    const toMonth = document.getElementById('reportToMonth').value;
    const memberFilter = document.getElementById('reportMemberFilter').value;
    
    if (!fromMonth || !toMonth) {
        showAlert('Please select both from and to months', 'error');
        return;
    }
    
    if (fromMonth > toMonth) {
        showAlert('From month cannot be later than to month', 'error');
        return;
    }
    
    try {
        showAlert('Generating report...', 'info');
        
        // Get all months in range
        const months = getMonthsInRange(fromMonth, toMonth);
        
        // Get ALL subscriptions in range with no limit
        const allSubscriptions = await getAllSubscriptions(fromMonth, toMonth);
        
        if (!allSubscriptions || allSubscriptions.length === 0) {
            showNoReportData();
            return;
        }
        
        // Get all members if needed
        let allMembers = [];
        if (memberFilter === 'active') {
            allMembers = await getAllMembers('active');
        }
        
        // Process report data
        reportData = processReportData(allSubscriptions, months, memberFilter, allMembers);
        
        // Display report
        displaySubscriptionReport(reportData, months);
        
        showAlert(`Report generated successfully! Found ${allSubscriptions.length} subscription records for ${reportData.memberCount} members.`, 'success');
        
    } catch (error) {
        console.error('Error generating report:', error);
        showAlert('Error generating report: ' + error.message, 'error');
    }
}

// Get all subscriptions with pagination to handle large datasets
async function getAllSubscriptions(fromMonth, toMonth) {
    let allSubscriptions = [];
    let from = 0;
    const limit = 1000; // Process in batches of 1000
    let hasMore = true;
    
    while (hasMore) {
        try {
            const { data: subscriptions, error: subError } = await supabase
                .from('subscriptions')
                .select(`
                    member_id, month, amount, payment_date,
                    members(id, name, status)
                `)
                .gte('month', fromMonth)
                .lte('month', toMonth)
                .order('members(name)')
                .order('month')
                .range(from, from + limit - 1);
            
            if (subError) throw subError;
            
            if (subscriptions && subscriptions.length > 0) {
                allSubscriptions = allSubscriptions.concat(subscriptions);
                from += limit;
                
                // Show progress for large datasets
                if (allSubscriptions.length >= 1000) {
                    showAlert(`Loading data... Found ${allSubscriptions.length} records so far`, 'info');
                }
                
                // If we got less than the limit, we're done
                if (subscriptions.length < limit) {
                    hasMore = false;
                }
            } else {
                hasMore = false;
            }
        } catch (error) {
            console.error('Error fetching subscriptions batch:', error);
            throw error;
        }
    }
    
    return allSubscriptions;
}

// Get all members with pagination
async function getAllMembers(status = null) {
    let allMembers = [];
    let from = 0;
    const limit = 1000;
    let hasMore = true;
    
    while (hasMore) {
        try {
            let query = supabase
                .from('members')
                .select('id, name, status')
                .order('name')
                .range(from, from + limit - 1);
            
            if (status) {
                query = query.eq('status', status);
            }
            
            const { data: members, error: memberError } = await query;
            
            if (memberError) throw memberError;
            
            if (members && members.length > 0) {
                allMembers = allMembers.concat(members);
                from += limit;
                
                if (members.length < limit) {
                    hasMore = false;
                }
            } else {
                hasMore = false;
            }
        } catch (error) {
            console.error('Error fetching members batch:', error);
            throw error;
        }
    }
    
    return allMembers;
}


// Get months in range
function getMonthsInRange(fromMonth, toMonth) {
    const months = [];
    const start = new Date(fromMonth + '-01');
    const end = new Date(toMonth + '-01');
    
    while (start <= end) {
        months.push(start.toISOString().slice(0, 7));
        start.setMonth(start.getMonth() + 1);
    }
    
    return months;
}

// Process report data
function processReportData(subscriptions, months, memberFilter, allMembers) {
    // Group subscriptions by member
    const memberData = {};
    const memberNames = {};
    let totalGrandTotal = 0;
    
    // Initialize data structure
    subscriptions.forEach(sub => {
        if (!memberData[sub.member_id]) {
            memberData[sub.member_id] = {};
            memberNames[sub.member_id] = sub.members.name;
        }
        
        if (!memberData[sub.member_id][sub.month]) {
            memberData[sub.member_id][sub.month] = 0;
        }
        
        memberData[sub.member_id][sub.month] += parseFloat(sub.amount);
        totalGrandTotal += parseFloat(sub.amount);
    });
    
    // Add active members with no payments if filter is 'active'
    if (memberFilter === 'active') {
        allMembers.forEach(member => {
            if (!memberData[member.id]) {
                memberData[member.id] = {};
                memberNames[member.id] = member.name;
            }
        });
    }
    
    // Calculate monthly totals
    const monthlyTotals = {};
    months.forEach(month => {
        monthlyTotals[month] = 0;
        Object.keys(memberData).forEach(memberId => {
            if (memberData[memberId][month]) {
                monthlyTotals[month] += memberData[memberId][month];
            }
        });
    });
    
    // Calculate member totals
    const memberTotals = {};
    Object.keys(memberData).forEach(memberId => {
        memberTotals[memberId] = 0;
        months.forEach(month => {
            if (memberData[memberId][month]) {
                memberTotals[memberId] += memberData[memberId][month];
            }
        });
    });
    
    return {
        memberData,
        memberNames,
        monthlyTotals,
        memberTotals,
        totalGrandTotal,
        memberCount: Object.keys(memberData).length,
        monthCount: months.length
    };
}



// Display report summary
function displayReportSummary(data, months) {
    const fromMonth = document.getElementById('reportFromMonth').value;
    const toMonth = document.getElementById('reportToMonth').value;
    const avgPerMember = data.memberCount > 0 ? (data.totalGrandTotal / data.memberCount) : 0;
    
    document.getElementById('reportTotalAmount').textContent = `‚Çπ${data.totalGrandTotal.toFixed(2)}`;
    document.getElementById('reportMemberCount').textContent = data.memberCount;
    document.getElementById('reportAvgPerMember').textContent = `‚Çπ${avgPerMember.toFixed(2)}`;
    document.getElementById('reportMonthCount').textContent = data.monthCount;
    
    const fromMonthName = new Date(fromMonth + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
    const toMonthName = new Date(toMonth + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
    document.getElementById('reportPeriodText').textContent = `${fromMonthName} to ${toMonthName}`;
}



// Reports functionality - Add these functions to your script section

// Set default report dates (last 6 months)
function setDefaultReportDates() {
    const currentDate = new Date();
    const currentMonth = currentDate.toISOString().slice(0, 7);
    
    // Set to month 6 months ago
    const fromDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 5, 1);
    const fromMonth = fromDate.toISOString().slice(0, 7);
    
    document.getElementById('reportFromMonth').value = fromMonth;
    document.getElementById('reportToMonth').value = currentMonth;
}

// Get months in range
function getMonthsInRange(fromMonth, toMonth) {
    const months = [];
    const start = new Date(fromMonth + '-01');
    const end = new Date(toMonth + '-01');
    
    while (start <= end) {
        months.push(start.toISOString().slice(0, 7));
        start.setMonth(start.getMonth() + 1);
    }
    
    return months;
}

// Process report data
function processReportData(subscriptions, months, memberFilter, allMembers) {
    // Group subscriptions by member
    const memberData = {};
    const memberNames = {};
    let totalGrandTotal = 0;
    
    // Initialize data structure
    subscriptions.forEach(sub => {
        if (!memberData[sub.member_id]) {
            memberData[sub.member_id] = {};
            memberNames[sub.member_id] = sub.members.name;
        }
        
        if (!memberData[sub.member_id][sub.month]) {
            memberData[sub.member_id][sub.month] = 0;
        }
        
        memberData[sub.member_id][sub.month] += parseFloat(sub.amount);
        totalGrandTotal += parseFloat(sub.amount);
    });
    
    // Add active members with no payments if filter is 'active'
    if (memberFilter === 'active') {
        allMembers.forEach(member => {
            if (!memberData[member.id]) {
                memberData[member.id] = {};
                memberNames[member.id] = member.name;
            }
        });
    }
    
    // Calculate monthly totals
    const monthlyTotals = {};
    months.forEach(month => {
        monthlyTotals[month] = 0;
        Object.keys(memberData).forEach(memberId => {
            if (memberData[memberId][month]) {
                monthlyTotals[month] += memberData[memberId][month];
            }
        });
    });
    
    // Calculate member totals
    const memberTotals = {};
    Object.keys(memberData).forEach(memberId => {
        memberTotals[memberId] = 0;
        months.forEach(month => {
            if (memberData[memberId][month]) {
                memberTotals[memberId] += memberData[memberId][month];
            }
        });
    });
    
    return {
        memberData,
        memberNames,
        monthlyTotals,
        memberTotals,
        totalGrandTotal,
        memberCount: Object.keys(memberData).length,
        monthCount: months.length
    };
}

// Display subscription report
function displaySubscriptionReport(data, months) {
    // Show summary
    displayReportSummary(data, months);
    
    // Build table headers
    let headerHTML = '<tr><th style="position: sticky; left: 0; background: #2c3e50; z-index: 11; min-width: 200px;">Member Name</th>';
    months.forEach(month => {
        const monthName = new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        headerHTML += `<th style="min-width: 120px;">${monthName}</th>`;
    });
    headerHTML += '<th style="background: #e74c3c; color: white; min-width: 120px;">Total</th></tr>';
    
    document.getElementById('reportTableHead').innerHTML = headerHTML;
    
    // Build table body
    let bodyHTML = '';
    const sortedMembers = Object.keys(data.memberNames).sort((a, b) => 
        data.memberNames[a].localeCompare(data.memberNames[b])
    );
    
    let displayedMemberCount = 0;
    
    sortedMembers.forEach(memberId => {
        const memberName = data.memberNames[memberId];
        const memberTotal = data.memberTotals[memberId];
        
        // Skip members with no payments if filter is 'with-payments'
        const memberFilter = document.getElementById('reportMemberFilter').value;
        if (memberFilter === 'with-payments' && memberTotal === 0) {
            return;
        }
        
        displayedMemberCount++;
        
        bodyHTML += `<tr>`;
        bodyHTML += `<td style="position: sticky; left: 0; background: white; font-weight: 600; z-index: 10; border-right: 2px solid #e1e8ed;">
                        <span style="color: #666; font-size: 12px;">MS${String(memberId).padStart(4, '0')}</span><br>
                        <span style="color: #2c3e50;">${memberName}</span>
                     </td>`;
        
        months.forEach(month => {
            const amount = data.memberData[memberId][month] || 0;
            const cellClass = amount > 0 ? 'style="color: #27ae60; font-weight: 600; text-align: right;"' : 'style="color: #bdc3c7; text-align: right;"';
            bodyHTML += `<td ${cellClass}>${amount > 0 ? `‚Çπ${amount.toFixed(2)}` : '-'}</td>`;
        });
        
        const totalClass = memberTotal > 0 ? 'style="background: #d4edda; color: #155724; font-weight: bold; text-align: right;"' : 'style="background: #f8d7da; color: #721c24; text-align: right;"';
        bodyHTML += `<td ${totalClass}>${memberTotal > 0 ? `‚Çπ${memberTotal.toFixed(2)}` : '‚Çπ0.00'}</td>`;
        bodyHTML += `</tr>`;
    });
    
    document.getElementById('reportTableBody').innerHTML = bodyHTML;
    
    // Build table footer (grand totals)
    let footerHTML = '<tr style="background: #34495e; color: white; font-weight: bold;">';
    footerHTML += '<td style="position: sticky; left: 0; background: #34495e; z-index: 11; border-right: 2px solid #2c3e50;">GRAND TOTAL</td>';
    
    months.forEach(month => {
        const monthTotal = data.monthlyTotals[month] || 0;
        footerHTML += `<td style="text-align: right;">${monthTotal > 0 ? `‚Çπ${monthTotal.toFixed(2)}` : '‚Çπ0.00'}</td>`;
    });
    
    footerHTML += `<td style="background: #e74c3c; text-align: right;">‚Çπ${data.totalGrandTotal.toFixed(2)}</td>`;
    footerHTML += '</tr>';
    
    document.getElementById('reportTableFoot').innerHTML = footerHTML;
    
    // Update member count to reflect displayed members
    data.displayedMemberCount = displayedMemberCount;
    
    // Show report elements
    document.getElementById('reportSummary').style.display = 'block';
    document.getElementById('reportTableContainer').style.display = 'block';
    document.getElementById('exportReportBtn').style.display = 'inline-block';
    document.getElementById('noReportData').style.display = 'none';
    
    // Scroll to report
    document.getElementById('reportSummary').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Display report summary
function displayReportSummary(data, months) {
    const fromMonth = document.getElementById('reportFromMonth').value;
    const toMonth = document.getElementById('reportToMonth').value;
    const memberFilter = document.getElementById('reportMemberFilter').value;
    
    // Calculate displayed member count
    let displayedMemberCount = data.memberCount;
    if (memberFilter === 'with-payments') {
        displayedMemberCount = Object.keys(data.memberTotals).filter(memberId => data.memberTotals[memberId] > 0).length;
    }
    
    const avgPerMember = displayedMemberCount > 0 ? (data.totalGrandTotal / displayedMemberCount) : 0;
    
    document.getElementById('reportTotalAmount').textContent = `‚Çπ${data.totalGrandTotal.toFixed(2)}`;
    document.getElementById('reportMemberCount').textContent = displayedMemberCount;
    document.getElementById('reportAvgPerMember').textContent = `‚Çπ${avgPerMember.toFixed(2)}`;
    document.getElementById('reportMonthCount').textContent = data.monthCount;
    
    const fromMonthName = new Date(fromMonth + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
    const toMonthName = new Date(toMonth + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
    document.getElementById('reportPeriodText').textContent = `${fromMonthName} to ${toMonthName}`;
}

// Show no data message
function showNoReportData() {
    document.getElementById('reportSummary').style.display = 'none';
    document.getElementById('reportTableContainer').style.display = 'none';
    document.getElementById('exportReportBtn').style.display = 'none';
    document.getElementById('noReportData').style.display = 'block';
}

// Export report to Excel
async function exportReportToExcel() {
    if (!reportData) {
        showAlert('No report data to export', 'error');
        return;
    }
    
    try {
        showAlert('Preparing Excel export...', 'info');
        
        const fromMonth = document.getElementById('reportFromMonth').value;
        const toMonth = document.getElementById('reportToMonth').value;
        const memberFilter = document.getElementById('reportMemberFilter').value;
        const months = getMonthsInRange(fromMonth, toMonth);
        
        // Prepare Excel data
        const excelData = [];
        
        // Add headers
        const headers = ['Member ID', 'Member Name'];
        months.forEach(month => {
            const monthName = new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            headers.push(monthName);
        });
        headers.push('Total');
        
        // Add data rows
        const sortedMembers = Object.keys(reportData.memberNames).sort((a, b) => 
            reportData.memberNames[a].localeCompare(reportData.memberNames[b])
        );
        
        sortedMembers.forEach(memberId => {
            const memberName = reportData.memberNames[memberId];
            const memberTotal = reportData.memberTotals[memberId];
            
            // Skip members with no payments if filter is 'with-payments'
            if (memberFilter === 'with-payments' && memberTotal === 0) {
                return;
            }
            
            const row = [`MS${String(memberId).padStart(4, '0')}`, memberName];
            
            months.forEach(month => {
                const amount = reportData.memberData[memberId][month] || 0;
                row.push(amount > 0 ? amount.toFixed(2) : 0);
            });
            
            row.push(memberTotal.toFixed(2));
            excelData.push(row);
        });
        
        // Add grand total row
        const grandTotalRow = ['', 'GRAND TOTAL'];
        months.forEach(month => {
            const monthTotal = reportData.monthlyTotals[month] || 0;
            grandTotalRow.push(monthTotal.toFixed(2));
        });
        grandTotalRow.push(reportData.totalGrandTotal.toFixed(2));
        excelData.push(grandTotalRow);
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([headers, ...excelData]);
        
        // Set column widths
        const colWidths = [
            { width: 12 }, // Member ID
            { width: 25 }, // Member Name
            ...months.map(() => ({ width: 15 })), // Month columns
            { width: 15 } // Total column
        ];
        ws['!cols'] = colWidths;
        
        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Subscription Report');
        
        // Add summary sheet
        const displayedMemberCount = memberFilter === 'with-payments' ? 
            Object.keys(reportData.memberTotals).filter(memberId => reportData.memberTotals[memberId] > 0).length :
            reportData.memberCount;
        
        const summaryData = [
            ['Summary', 'Value'],
            ['Report Period', `${fromMonth} to ${toMonth}`],
            ['Total Collection', `‚Çπ${reportData.totalGrandTotal.toFixed(2)}`],
            ['Members Included', displayedMemberCount],
            ['Months Covered', reportData.monthCount],
            ['Average per Member', `‚Çπ${displayedMemberCount > 0 ? (reportData.totalGrandTotal / displayedMemberCount).toFixed(2) : '0.00'}`],
            ['Filter Applied', memberFilter || 'All Members'],
            ['Generated On', new Date().toLocaleString()],
            ['Generated By', 'Member Management Portal']
        ];
        
        const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
        summaryWs['!cols'] = [{ width: 20 }, { width: 30 }];
        XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
        
        // Generate filename
        const fileName = `Subscription_Report_${fromMonth}_to_${toMonth}_${new Date().getTime()}.xlsx`;
        
        // Save file
        XLSX.writeFile(wb, fileName);
        
        showAlert('‚úÖ Excel report exported successfully!', 'success');
        
    } catch (error) {
        console.error('Error exporting report:', error);
        showAlert('Error exporting report: ' + error.message, 'error');
    }
}


        // Setup event listeners
        function setupEventListeners() {
            // Add member form
            document.getElementById('addMemberForm').addEventListener('submit', handleAddMember);
            
            // Edit member form
            document.getElementById('editMemberForm').addEventListener('submit', handleEditMember);
            
            // Bulk subscription forms
            document.getElementById('bulkAllForm').addEventListener('submit', handleBulkAllSubscription);
            document.getElementById('bulkSelectedForm').addEventListener('submit', handleBulkSelectedSubscription);
            
            // Search functionality
            setupMemberSearch();
            setupSelectiveSearch();
            
            // Set default dates
            setDefaultDates();

            setDefaultDates();
            setDefaultReportDates();
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            document.getElementById('joinDate').value = today;
            document.getElementById('bulkPaymentDate').value = today;
            document.getElementById('selectedBulkDate').value = today;
            document.getElementById('bulkMonth').value = currentMonth;
            document.getElementById('selectedBulkMonth').value = currentMonth;
        }

        // Load initial data
        async function loadInitialData() {
            await Promise.all([
                loadAllMembers(),
                loadStatistics()
            ]);
        }

        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'statistics') {
                loadStatistics();
            } else if (tabName === 'view-all') {
                loadAllMembers();
            }
        }

        // Member search functionality
        function setupMemberSearch() {
            const searchInput = document.getElementById('memberSearch');
            const resultsDiv = document.getElementById('searchResults');
            
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (searchTerm.length < 2) {
                    resultsDiv.style.display = 'none';
                    document.getElementById('selectedMemberDetails').innerHTML = '';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchMembers(searchTerm, resultsDiv, 'main');
                }, 300);
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        // Selective search for bulk operations
        function setupSelectiveSearch() {
            const searchInput = document.getElementById('selectiveSearch');
            
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (searchTerm.length < 2) {
                    document.getElementById('selectiveBulkContainer').style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    loadSelectiveMembers(searchTerm);
                }, 300);
            });
        }

        // Search members
        async function searchMembers(searchTerm, resultsDiv, context = 'main') {
            try {
                let query = supabase
                    .from('members')
                    .select('*');
                
                // Check if searchTerm is a member ID pattern
                if (/^(MS)?\d+$/i.test(searchTerm)) {
                    const numericId = parseInt(searchTerm.replace(/^MS/i, ''));
                    query = query.eq('id', numericId);
                } else {
                    // Search by name or contact
                    query = query.or(`name.ilike.%${searchTerm}%,contact.ilike.%${searchTerm}%`);
                }
                
                const { data: members, error } = await query
                    .order('name')
                    .limit(10);
                
                if (error) throw error;
                
                displaySearchResults(members || [], resultsDiv, context);
                
            } catch (error) {
                console.error('Error searching members:', error);
                showAlert('Error searching members: ' + error.message, 'error');
            }
        }

        // Display search results
        function displaySearchResults(members, resultsDiv, context) {
            if (members.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">No members found</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '';
            members.forEach(member => {
                const subscriptionDisplay = member.subscription_amount > 0 ? 
                    `‚Çπ${parseFloat(member.subscription_amount).toFixed(2)}/month` : 'Variable amount';
                
                html += `
                    <div class="search-result-item" onclick="selectMember(${member.id}, '${context}')">
                        <div class="member-id">MS${String(member.id).padStart(4, '0')}</div>
                        <div class="member-name">${member.name}</div>
                        <div class="member-details">
                            üì± ${member.contact} | üí∞ ${subscriptionDisplay} | 
                            <span class="status-badge status-${member.status}">${member.status.toUpperCase()}</span>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // Select member from search results
        async function selectMember(memberId, context) {
            try {
                const { data: member, error } = await supabase
                    .from('members')
                    .select('*')
                    .eq('id', memberId)
                    .single();
                
                if (error) throw error;
                
                if (context === 'main') {
                    displayMemberDetails(member);
                    document.getElementById('searchResults').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading member details:', error);
                showAlert('Error loading member details', 'error');
            }
        }

        // Display member details
        function displayMemberDetails(member) {
            const subscriptionDisplay = member.subscription_amount > 0 ? 
                `‚Çπ${parseFloat(member.subscription_amount).toFixed(2)}` : 'Variable';
            
            const memberCard = `
                <div class="member-card ${member.status === 'suspended' ? 'suspended' : ''}">
                    <div class="member-header">
                        <h3>MS${String(member.id).padStart(4, '0')} - ${member.name}</h3>
                        <span class="status-badge status-${member.status}">${member.status.toUpperCase()}</span>
                    </div>
                    
                    <div class="member-info">
                        <div class="info-item">
                            <div class="info-label">Contact Number</div>
                            <div class="info-value">üì± ${member.contact}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Join Date</div>
                            <div class="info-value">üìÖ ${new Date(member.join_date).toLocaleDateString()}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Monthly Subscription</div>
                            <div class="info-value subscription-amount">üí∞ ${subscriptionDisplay}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Member Since</div>
                            <div class="info-value">üóìÔ∏è ${Math.floor((new Date() - new Date(member.join_date)) / (1000 * 60 * 60 * 24))} days</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-small" onclick="editMember(${member.id})">
                            ‚úèÔ∏è Edit Details
                        </button>
                        <button class="btn btn-success btn-small" onclick="addIndividualSubscription(${member.id})">
                            üí∞ Add Subscription
                        </button>
                        <button class="btn btn-warning btn-small" onclick="viewMemberSubscriptions(${member.id})">
                            üìã View Subscriptions
                        </button>
                        ${member.status === 'active' ? 
                            `<button class="btn btn-danger btn-small" onclick="suspendMember(${member.id})">‚è∏Ô∏è Suspend</button>` :
                            `<button class="btn btn-success btn-small" onclick="activateMember(${member.id})">‚ñ∂Ô∏è Activate</button>`
                        }
                        <a href="https://wa.me/${member.contact}" target="_blank" class="btn btn-success btn-small">
                            üì± WhatsApp
                        </a>
                    </div>
                </div>
            `;
            
            document.getElementById('selectedMemberDetails').innerHTML = memberCard;
        }

        // Handle add member
        async function handleAddMember(event) {
            event.preventDefault();
            
            const memberData = {
                name: document.getElementById('memberName').value.trim(),
                contact: document.getElementById('memberContact').value.trim(),
                join_date: document.getElementById('joinDate').value,
                subscription_amount: parseFloat(document.getElementById('subscriptionAmount').value) || 0
            };
            
            // Validation
            if (!memberData.name || !memberData.contact || !memberData.join_date) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            if (memberData.contact.length !== 10 || !/^\d+$/.test(memberData.contact)) {
                showAlert('Contact number must be exactly 10 digits', 'error');
                return;
            }
            
            if (memberData.subscription_amount < 0) {
                showAlert('Subscription amount cannot be negative', 'error');
                return;
            }
            
            try {
                // Check for duplicate contact
                const { data: existingMember } = await supabase
                    .from('members')
                    .select('id')
                    .eq('contact', memberData.contact)
                    .single();
                
                if (existingMember) {
                    showAlert('Member with this contact number already exists', 'error');
                    return;
                }
                
                // Add member
                const { data: newMember, error } = await supabase
                    .from('members')
                    .insert({
                        name: memberData.name,
                        contact: memberData.contact,
                        join_date: memberData.join_date,
                        subscription_amount: memberData.subscription_amount,
                        status: 'active'
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                showAlert(`‚úÖ Member ${newMember.name} added successfully with ID MS${String(newMember.id).padStart(4, '0')}`, 'success');
                
                // Reset form
                document.getElementById('addMemberForm').reset();
                setDefaultDates();
                
                // Refresh data
                await Promise.all([
                    loadAllMembers(),
                    loadStatistics()
                ]);
                
            } catch (error) {
                console.error('Error adding member:', error);
                showAlert('Error adding member: ' + error.message, 'error');
            }
        }

        // Handle bulk subscription for all members
        async function handleBulkAllSubscription(event) {
            event.preventDefault();
            
            const month = document.getElementById('bulkMonth').value;
            const paymentDate = document.getElementById('bulkPaymentDate').value;
            const defaultAmount = parseFloat(document.getElementById('bulkDefaultAmount').value);
            
            if (!month || !paymentDate || !defaultAmount) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            if (!confirm(`Add subscriptions for ${month}?\n\nDefault amount: ‚Çπ${defaultAmount}\nMembers with preset amounts will use their default rates.\n\nContinue?`)) {
                return;
            }
            
            await processBulkSubscription(null, month, paymentDate, defaultAmount);
        }

        // Process bulk subscription
        async function processBulkSubscription(memberIds, month, paymentDate, defaultAmount) {
            try {
                // Get members (all active or specific IDs)
                let query = supabase
                    .from('members')
                    .select('id, name, subscription_amount')
                    .eq('status', 'active');
                
                if (memberIds) {
                    query = query.in('id', Array.from(memberIds));
                }
                
                const { data: members, error: membersError } = await query;
                if (membersError) throw membersError;
                
                if (!members || members.length === 0) {
                    showAlert('No eligible members found', 'warning');
                    return;
                }
                
                // Check existing subscriptions
                const { data: existingSubscriptions, error: subError } = await supabase
                    .from('subscriptions')
                    .select('member_id')
                    .eq('month', month);
                
                if (subError) throw subError;
                
                const existingMemberIds = new Set((existingSubscriptions || []).map(sub => sub.member_id));
                
                // Prepare subscriptions
                const subscriptionsToAdd = [];
                let totalAmount = 0;
                let customAmountCount = 0;
                
                members.forEach(member => {
                    if (!existingMemberIds.has(member.id)) {
                        const subscriptionAmount = member.subscription_amount > 0 ? 
                            member.subscription_amount : defaultAmount;
                        
                        if (member.subscription_amount > 0) {
                            customAmountCount++;
                        }
                        
                        subscriptionsToAdd.push({
                            member_id: member.id,
                            month: month,
                            amount: subscriptionAmount,
                            payment_date: paymentDate
                        });
                        
                        totalAmount += subscriptionAmount;
                    }
                });
                
                if (subscriptionsToAdd.length === 0) {
                    showAlert('All eligible members already have subscriptions for this month', 'warning');
                    return;
                }
                
                // Insert subscriptions
                const { error: insertError } = await supabase
                    .from('subscriptions')
                    .insert(subscriptionsToAdd);
                
                if (insertError) throw insertError;
                
                const averageAmount = (totalAmount / subscriptionsToAdd.length).toFixed(2);
                
                showAlert(`‚úÖ Bulk subscription completed!\n\n` +
                         `‚Ä¢ Added: ${subscriptionsToAdd.length} subscriptions\n` +
                         `‚Ä¢ Skipped: ${members.length - subscriptionsToAdd.length} (already paid)\n` +
                         `‚Ä¢ Total Amount: ‚Çπ${totalAmount.toFixed(2)}\n` +
                         `‚Ä¢ Average: ‚Çπ${averageAmount}\n` +
                         `‚Ä¢ Members using preset amounts: ${customAmountCount}`, 'success');
                
                // Reset forms
                document.getElementById('bulkAllForm').reset();
                if (document.getElementById('bulkSelectedForm')) {
                    document.getElementById('bulkSelectedForm').reset();
                }
                setDefaultDates();
                
                // Clear selections
                clearBulkSelection();
                
            } catch (error) {
                console.error('Error in bulk subscription:', error);
                showAlert('Error adding bulk subscriptions: ' + error.message, 'error');
            }
        }

        // Load selective members for bulk subscription
        async function loadSelectiveMembers(searchTerm) {
            try {
                const { data: members, error } = await supabase
                    .from('members')
                    .select('*')
                    .eq('status', 'active')
                    .or(`name.ilike.%${searchTerm}%,contact.ilike.%${searchTerm}%`)
                    .order('name')
                    .limit(20);
                
                if (error) throw error;
                
                displaySelectiveMembers(members || []);
                
            } catch (error) {
                console.error('Error loading selective members:', error);
            }
        }

        // Display selective members with checkboxes
        function displaySelectiveMembers(members) {
            const container = document.getElementById('selectiveBulkContainer');
            const listDiv = document.getElementById('selectiveMembersList');
            
            if (members.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            let html = '';
            members.forEach(member => {
                const isSelected = selectedMembers.has(member.id);
                const subscriptionDisplay = member.subscription_amount > 0 ? 
                    `‚Çπ${parseFloat(member.subscription_amount).toFixed(2)}/month` : 'Variable amount';
                
                html += `
                    <div class="member-card" style="margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="checkbox" class="member-checkbox" 
                                   ${isSelected ? 'checked' : ''} 
                                   onchange="toggleMemberSelection(${member.id})">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">MS${String(member.id).padStart(4, '0')} - ${member.name}</div>
                                <div style="font-size: 12px; color: #666;">
                                    üì± ${member.contact} | üí∞ ${subscriptionDisplay}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            container.style.display = 'block';
            updateBulkSelectionBar();
        }

        // Toggle member selection
        function toggleMemberSelection(memberId) {
            if (selectedMembers.has(memberId)) {
                selectedMembers.delete(memberId);
            } else {
                selectedMembers.add(memberId);
            }
            updateBulkSelectionBar();
        }

        // Update bulk selection bar
        function updateBulkSelectionBar() {
            const selectionBar = document.getElementById('bulkSelectionBar');
            const countSpan = document.getElementById('selectedCount');
            
            if (selectedMembers.size > 0) {
                selectionBar.classList.add('active');
                countSpan.textContent = `${selectedMembers.size} members selected`;
            } else {
                selectionBar.classList.remove('active');
            }
        }

        // Clear bulk selection
        function clearBulkSelection() {
            selectedMembers.clear();
            updateBulkSelectionBar();
            
            // Uncheck all checkboxes
            document.querySelectorAll('.member-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Process bulk selection
        function processBulkSelection() {
            if (selectedMembers.size === 0) {
                showAlert('Please select at least one member', 'error');
                return;
            }
            
            // Update summary
            document.getElementById('selectedMembersCount').textContent = selectedMembers.size;
            
            // Show modal
            document.getElementById('bulkSelectionModal').style.display = 'block';
        }

        // Handle bulk selected subscription
        async function handleBulkSelectedSubscription(event) {
            event.preventDefault();
            
            const month = document.getElementById('selectedBulkMonth').value;
            const paymentDate = document.getElementById('selectedBulkDate').value;
            const defaultAmount = parseFloat(document.getElementById('selectedBulkAmount').value);
            
            if (!month || !paymentDate || !defaultAmount) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            await processBulkSubscription(selectedMembers, month, paymentDate, defaultAmount);
            closeBulkModal();
        }

        // Load all members with pagination support
        async function loadAllMembers() {
            try {
                showAlert('Loading members...', 'info');
                
                // Use the new getAllMembers function
                const members = await getAllMembers();
                
                allMembers = members || [];
                displayAllMembers(allMembers);
                
                if (allMembers.length > 0) {
                    showAlert(`Loaded ${allMembers.length} members successfully`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading members:', error);
                showAlert('Error loading members: ' + error.message, 'error');
            }
        }

        // Display all members in table
        function displayAllMembers(members) {
            const tbody = document.querySelector('#allMembersTable tbody');
            
            if (members.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <div class="empty-state">
                                <h3>No Members Found</h3>
                                <p>Add your first member to get started</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            members.forEach(member => {
                const subscriptionDisplay = member.subscription_amount > 0 ? 
                    `‚Çπ${parseFloat(member.subscription_amount).toFixed(2)}` : 'Variable';
                
                html += `
                    <tr>
                        <td><strong>MS${String(member.id).padStart(4, '0')}</strong></td>
                        <td>${member.name}</td>
                        <td>${member.contact}</td>
                        <td>${new Date(member.join_date).toLocaleDateString()}</td>
                        <td><span style="font-weight: 600; color: #27ae60;">${subscriptionDisplay}</span></td>
                        <td><span class="status-badge status-${member.status}">${member.status.toUpperCase()}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-small" onclick="editMember(${member.id})">‚úèÔ∏è Edit</button>
                                ${member.status === 'active' ? 
                                    `<button class="btn btn-danger btn-small" onclick="suspendMember(${member.id})">‚è∏Ô∏è Suspend</button>` :
                                    `<button class="btn btn-success btn-small" onclick="activateMember(${member.id})">‚ñ∂Ô∏è Activate</button>`
                                }
                                <a href="https://wa.me/${member.contact}" target="_blank" class="btn btn-success btn-small">üì± WhatsApp</a>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Filter members
        function filterMembers() {
            const statusFilter = document.getElementById('statusFilter').value;
            
            if (!statusFilter) {
                displayAllMembers(allMembers);
                return;
            }
            
            const filteredMembers = allMembers.filter(member => member.status === statusFilter);
            displayAllMembers(filteredMembers);
        }

        // Edit member
        async function editMember(memberId) {
            try {
                const { data: member, error } = await supabase
                    .from('members')
                    .select('*')
                    .eq('id', memberId)
                    .single();
                
                if (error) throw error;
                
                // Populate modal
                document.getElementById('editMemberId').value = member.id;
                document.getElementById('editMemberName').value = member.name;
                document.getElementById('editMemberContact').value = member.contact;
                document.getElementById('editSubscriptionAmount').value = member.subscription_amount || 0;
                document.getElementById('editMemberStatus').value = member.status;
                
                // Show modal
                document.getElementById('editMemberModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading member for edit:', error);
                showAlert('Error loading member details', 'error');
            }
        }

        // Handle edit member
        async function handleEditMember(event) {
            event.preventDefault();
            
            const memberId = document.getElementById('editMemberId').value;
            const memberData = {
                name: document.getElementById('editMemberName').value.trim(),
                contact: document.getElementById('editMemberContact').value.trim(),
                subscription_amount: parseFloat(document.getElementById('editSubscriptionAmount').value) || 0,
                status: document.getElementById('editMemberStatus').value
            };
            
            if (!memberData.name || !memberData.contact) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            if (memberData.contact.length !== 10 || !/^\d+$/.test(memberData.contact)) {
                showAlert('Contact number must be exactly 10 digits', 'error');
                return;
            }
            
            if (memberData.subscription_amount < 0) {
                showAlert('Subscription amount cannot be negative', 'error');
                return;
            }
            
            try {
                // Check for duplicate contact (excluding current member)
                const { data: existingMember } = await supabase
                    .from('members')
                    .select('id')
                    .eq('contact', memberData.contact)
                    .neq('id', memberId)
                    .single();
                
                if (existingMember) {
                    showAlert('Another member with this contact number already exists', 'error');
                    return;
                }
                
                // Update member
                const { error } = await supabase
                    .from('members')
                    .update(memberData)
                    .eq('id', memberId);
                
                if (error) throw error;
                
                showAlert('‚úÖ Member updated successfully', 'success');
                closeEditModal();
                
                // Refresh data
                await Promise.all([
                    loadAllMembers(),
                    loadStatistics()
                ]);
                
                // Update search results if member is displayed
                const detailsDiv = document.getElementById('selectedMemberDetails');
                if (detailsDiv.innerHTML.includes(`MS${String(memberId).padStart(4, '0')}`)) {
                    selectMember(memberId, 'main');
                }
                
            } catch (error) {
                console.error('Error updating member:', error);
                showAlert('Error updating member: ' + error.message, 'error');
            }
        }

        // Suspend member
        async function suspendMember(memberId) {
            if (!confirm('Are you sure you want to suspend this member?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('members')
                    .update({ status: 'suspended' })
                    .eq('id', memberId);
                
                if (error) throw error;
                
                showAlert('‚úÖ Member suspended successfully', 'success');
                
                // Refresh data
                await Promise.all([
                    loadAllMembers(),
                    loadStatistics()
                ]);
                
            } catch (error) {
                console.error('Error suspending member:', error);
                showAlert('Error suspending member: ' + error.message, 'error');
            }
        }

        // Activate member
        async function activateMember(memberId) {
            try {
                const { error } = await supabase
                    .from('members')
                    .update({ status: 'active' })
                    .eq('id', memberId);
                
                if (error) throw error;
                
                showAlert('‚úÖ Member activated successfully', 'success');
                
                // Refresh data
                await Promise.all([
                    loadAllMembers(),
                    loadStatistics()
                ]);
                
            } catch (error) {
                console.error('Error activating member:', error);
                showAlert('Error activating member: ' + error.message, 'error');
            }
        }

            // Load statistics with proper counting for large datasets
            async function loadStatistics() {
                try {
                    showAlert('Loading statistics...', 'info');
                    
                    // Get all members for accurate statistics
                    const members = await getAllMembers();
                    
                    const stats = {
                        total: members.length,
                        active: members.filter(m => m.status === 'active').length,
                        suspended: members.filter(m => m.status === 'suspended').length,
                        totalSubscriptionValue: members
                            .filter(m => m.status === 'active' && m.subscription_amount > 0)
                            .reduce((sum, m) => sum + parseFloat(m.subscription_amount || 0), 0)
                    };
                    
                    // Update statistics display
                    document.getElementById('totalMembers').textContent = stats.total;
                    document.getElementById('activeMembers').textContent = stats.active;
                    document.getElementById('suspendedMembers').textContent = stats.suspended;
                    document.getElementById('totalSubscriptionValue').textContent = `‚Çπ${stats.totalSubscriptionValue.toFixed(2)}`;
                    
                    // Load subscription analysis
                    await loadSubscriptionAnalysis();
                    
                    // Load recent activity
                    await loadRecentActivity();
                    
                    showAlert(`Statistics loaded for ${stats.total} members`, 'success');
                    
                } catch (error) {
                    console.error('Error loading statistics:', error);
                    showAlert('Error loading statistics: ' + error.message, 'error');
                }
            }

        // Load subscription analysis
        async function loadSubscriptionAnalysis() {
            try {
                const { data: members, error } = await supabase
                    .from('members')
                    .select('subscription_amount, status');
                
                if (error) throw error;
                
                const activeMembers = members.filter(m => m.status === 'active');
                const withPresetAmount = activeMembers.filter(m => m.subscription_amount > 0);
                const variableAmount = activeMembers.filter(m => m.subscription_amount === 0);
                
                const avgSubscription = withPresetAmount.length > 0 ? 
                    (withPresetAmount.reduce((sum, m) => sum + m.subscription_amount, 0) / withPresetAmount.length).toFixed(2) : 0;
                
                const analysisHTML = `
                    <div class="stats-grid">
                        <div class="info-item">
                            <div class="info-label">Members with Preset Amounts</div>
                            <div class="info-value">${withPresetAmount.length}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Members with Variable Amounts</div>
                            <div class="info-value">${variableAmount.length}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Average Subscription</div>
                            <div class="info-value">‚Çπ${avgSubscription}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Collection Efficiency</div>
                            <div class="info-value">${((withPresetAmount.length / activeMembers.length) * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('subscriptionAnalysis').innerHTML = analysisHTML;
                
            } catch (error) {
                console.error('Error loading subscription analysis:', error);
                document.getElementById('subscriptionAnalysis').innerHTML = '<p>Error loading analysis</p>';
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                // Get recent members (last 10)
                const { data: recentMembers, error: membersError } = await supabase
                    .from('members')
                    .select('name, created_at, status')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (membersError) throw membersError;
                
                // Get recent subscriptions (last 10)
                const { data: recentSubscriptions, error: subsError } = await supabase
                    .from('subscriptions')
                    .select(`
                        amount, payment_date, month,
                        members(name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (subsError) throw subsError;
                
                let activityHTML = '<h4>üÜï Recent Members</h4>';
                
                if (recentMembers && recentMembers.length > 0) {
                    activityHTML += '<ul style="list-style: none; padding: 0;">';
                    recentMembers.forEach(member => {
                        const timeAgo = Math.floor((new Date() - new Date(member.created_at)) / (1000 * 60 * 60 * 24));
                        activityHTML += `
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                <strong>${member.name}</strong> joined 
                                <span style="color: #666;">${timeAgo} days ago</span>
                                <span class="status-badge status-${member.status}">${member.status}</span>
                            </li>
                        `;
                    });
                    activityHTML += '</ul>';
                } else {
                    activityHTML += '<p>No recent members</p>';
                }
                
                activityHTML += '<h4 style="margin-top: 20px;">üí∞ Recent Subscriptions</h4>';
                
                if (recentSubscriptions && recentSubscriptions.length > 0) {
                    activityHTML += '<ul style="list-style: none; padding: 0;">';
                    recentSubscriptions.forEach(sub => {
                        const timeAgo = Math.floor((new Date() - new Date(sub.payment_date)) / (1000 * 60 * 60 * 24));
                        activityHTML += `
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                <strong>${sub.members.name}</strong> paid ‚Çπ${sub.amount} 
                                for ${sub.month} 
                                <span style="color: #666;">(${timeAgo} days ago)</span>
                            </li>
                        `;
                    });
                    activityHTML += '</ul>';
                } else {
                    activityHTML += '<p>No recent subscriptions</p>';
                }
                
                document.getElementById('recentActivity').innerHTML = activityHTML;
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = '<p>Error loading recent activity</p>';
            }
        }

        // Export members to Excel
        async function exportMembersToExcel() {
            try {
                showAlert('Preparing Excel export...', 'info');
                
                const { data: members, error } = await supabase
                    .from('members')
                    .select('*')
                    .order('id');
                
                if (error) throw error;
                
                if (!members || members.length === 0) {
                    showAlert('No members found to export', 'warning');
                    return;
                }
                
                // Prepare Excel data
                const excelData = members.map(member => ({
                    'Member ID': `MS${String(member.id).padStart(4, '0')}`,
                    'Name': member.name,
                    'Contact Number': member.contact,
                    'Join Date': new Date(member.join_date).toLocaleDateString(),
                    'Monthly Subscription': member.subscription_amount > 0 ? 
                        `‚Çπ${parseFloat(member.subscription_amount).toFixed(2)}` : 'Variable',
                    'Status': member.status.toUpperCase(),
                    'Created At': new Date(member.created_at).toLocaleDateString(),
                    'Updated At': member.updated_at ? new Date(member.updated_at).toLocaleDateString() : ''
                }));
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Set column widths
                const colWidths = [
                    { width: 12 }, // Member ID
                    { width: 25 }, // Name
                    { width: 15 }, // Contact
                    { width: 12 }, // Join Date
                    { width: 18 }, // Monthly Subscription
                    { width: 10 }, // Status
                    { width: 12 }, // Created At
                    { width: 12 }  // Updated At
                ];
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Members');
                
                // Add summary sheet
                const totalSubscriptionValue = members
                    .filter(m => m.subscription_amount > 0)
                    .reduce((sum, m) => sum + parseFloat(m.subscription_amount), 0);
                
                const summaryData = [
                    { 'Summary': 'Total Members', 'Value': members.length },
                    { 'Summary': 'Active Members', 'Value': members.filter(m => m.status === 'active').length },
                    { 'Summary': 'Suspended Members', 'Value': members.filter(m => m.status === 'suspended').length },
                    { 'Summary': 'Members with Preset Subscription', 'Value': members.filter(m => m.subscription_amount > 0).length },
                    { 'Summary': 'Members with Variable Subscription', 'Value': members.filter(m => m.subscription_amount === 0).length },
                    { 'Summary': 'Total Monthly Subscription Value', 'Value': `‚Çπ${totalSubscriptionValue.toFixed(2)}` },
                    { 'Summary': 'Export Date', 'Value': new Date().toLocaleString() },
                    { 'Summary': 'Exported By', 'Value': 'Member Management Portal' }
                ];
                
                const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                summaryWs['!cols'] = [{ width: 30 }, { width: 25 }];
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
                
                // Generate filename
                const fileName = `members_export_${new Date().toISOString().split('T')[0]}_${new Date().getTime()}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, fileName);
                
                showAlert(`‚úÖ Excel export completed! ${members.length} members exported successfully.`, 'success');
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showAlert('Error exporting to Excel: ' + error.message, 'error');
            }
        }

        // Modal functions
        function closeEditModal() {
            document.getElementById('editMemberModal').style.display = 'none';
        }

        function closeBulkModal() {
            document.getElementById('bulkSelectionModal').style.display = 'none';
        }

// Individual subscription functions - Replace the placeholder implementations
function addIndividualSubscription(memberId) {
    // Get member details first
    const member = allMembers.find(m => m.id === memberId);
    if (!member) {
        showAlert('Member not found', 'error');
        return;
    }
    
    // Create and show subscription modal
    showSubscriptionModal(member);
}

function viewMemberSubscriptions(memberId) {
    // Get member details first
    const member = allMembers.find(m => m.id === memberId);
    if (!member) {
        showAlert('Member not found', 'error');
        return;
    }
    
    // Load and show subscription history
    loadMemberSubscriptionHistory(memberId, member.name);
}

// Add Individual Subscription Modal
function showSubscriptionModal(member) {
    const modalHTML = `
        <div id="individualSubscriptionModal" class="modal" style="display: block;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üí∞ Add Subscription for ${member.name}</h3>
                    <span class="close" onclick="closeIndividualSubscriptionModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="individualSubscriptionForm">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="indivSubMonth">Select Month *</label>
                                <input type="month" id="indivSubMonth" required>
                            </div>
                            <div class="form-col">
                                <label for="indivSubAmount">Subscription Amount *</label>
                                <input type="number" id="indivSubAmount" required min="0" step="0.01" 
                                       value="${member.subscription_amount || ''}" 
                                       placeholder="Enter subscription amount">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="indivSubDate">Payment Date *</label>
                                <input type="date" id="indivSubDate" required>
                            </div>
                            <div class="form-col">
                                <!-- Empty for layout -->
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <strong>Member Details:</strong><br>
                            ‚Ä¢ ID: MS${String(member.id).padStart(4, '0')}<br>
                            ‚Ä¢ Name: ${member.name}<br>
                            ‚Ä¢ Contact: ${member.contact}<br>
                            ‚Ä¢ Default Subscription: ${member.subscription_amount > 0 ? `‚Çπ${member.subscription_amount}` : 'Variable'}
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <button type="submit" class="btn btn-success">
                                    üí∞ Add Subscription
                                </button>
                            </div>
                            <div class="form-col">
                                <button type="button" class="btn btn-secondary" onclick="closeIndividualSubscriptionModal()">
                                    ‚ùå Cancel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('individualSubscriptionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Set default date
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = new Date().toISOString().slice(0, 7);
    document.getElementById('indivSubDate').value = today;
    document.getElementById('indivSubMonth').value = currentMonth;
    
    // Add form submit handler
    document.getElementById('individualSubscriptionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleIndividualSubscription(member.id);
    });
}

// Handle individual subscription submission
async function handleIndividualSubscription(memberId) {
    const month = document.getElementById('indivSubMonth').value;
    const amount = parseFloat(document.getElementById('indivSubAmount').value);
    const paymentDate = document.getElementById('indivSubDate').value;
    
    if (!month || !amount || !paymentDate) {
        showAlert('Please fill all required fields', 'error');
        return;
    }
    
    if (amount <= 0) {
        showAlert('Subscription amount must be greater than 0', 'error');
        return;
    }
    
    try {
        // Check if subscription already exists
        const { data: existingSubscription, error: checkError } = await supabase
            .from('subscriptions')
            .select('id')
            .eq('member_id', memberId)
            .eq('month', month)
            .single();
        
        if (checkError && checkError.code !== 'PGRST116') {
            throw checkError;
        }
        
        if (existingSubscription) {
            showAlert('Subscription already exists for this member and month', 'error');
            return;
        }
        
        // Add subscription
        const { error: insertError } = await supabase
            .from('subscriptions')
            .insert({
                member_id: memberId,
                month: month,
                amount: amount,
                payment_date: paymentDate
            });
        
        if (insertError) throw insertError;
        
        showAlert(`‚úÖ Subscription added successfully!\nMonth: ${month}\nAmount: ‚Çπ${amount.toFixed(2)}`, 'success');
        closeIndividualSubscriptionModal();
        
        // Refresh member details if displayed
        const member = allMembers.find(m => m.id === memberId);
        if (member) {
            displayMemberDetails(member);
        }
        
    } catch (error) {
        console.error('Error adding individual subscription:', error);
        showAlert('Error adding subscription: ' + error.message, 'error');
    }
}

// Close individual subscription modal
function closeIndividualSubscriptionModal() {
    const modal = document.getElementById('individualSubscriptionModal');
    if (modal) {
        modal.remove();
    }
}

// Load and display member subscription history
async function loadMemberSubscriptionHistory(memberId, memberName) {
    try {
        showAlert('Loading subscription history...', 'info');
        
        const { data: subscriptions, error } = await supabase
            .from('subscriptions')
            .select('*')
            .eq('member_id', memberId)
            .order('month', { ascending: false });
        
        if (error) throw error;
        
        showSubscriptionHistoryModal(memberId, memberName, subscriptions || []);
        
    } catch (error) {
        console.error('Error loading subscription history:', error);
        showAlert('Error loading subscription history: ' + error.message, 'error');
    }
}

// Show subscription history modal
function showSubscriptionHistoryModal(memberId, memberName, subscriptions) {
    const totalAmount = subscriptions.reduce((sum, sub) => sum + parseFloat(sub.amount), 0);
    const avgAmount = subscriptions.length > 0 ? (totalAmount / subscriptions.length).toFixed(2) : 0;
    
    let historyHTML = '';
    if (subscriptions.length === 0) {
        historyHTML = `
            <div class="empty-state">
                <h3>No Subscription History</h3>
                <p>This member hasn't made any subscription payments yet.</p>
                <button class="btn btn-primary" onclick="closeSubscriptionHistoryModal(); addIndividualSubscription(${memberId})">
                    üí∞ Add First Subscription
                </button>
            </div>
        `;
    } else {
        historyHTML = `
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="info-item">
                    <div class="info-label">Total Payments</div>
                    <div class="info-value">${subscriptions.length}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Amount</div>
                    <div class="info-value">‚Çπ${totalAmount.toFixed(2)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Average Amount</div>
                    <div class="info-value">‚Çπ${avgAmount}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Latest Payment</div>
                    <div class="info-value">${new Date(subscriptions[0].payment_date).toLocaleDateString()}</div>
                </div>
            </div>
            
            <div class="table-container">
                <table style="font-size: 14px;">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Amount</th>
                            <th>Payment Date</th>
                            <th>Days Ago</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        subscriptions.forEach(sub => {
            const daysAgo = Math.floor((new Date() - new Date(sub.payment_date)) / (1000 * 60 * 60 * 24));
            
            historyHTML += `
                <tr>
                    <td><strong>${sub.month}</strong></td>
                    <td style="color: #27ae60; font-weight: 600;">‚Çπ${parseFloat(sub.amount).toFixed(2)}</td>
                    <td>${new Date(sub.payment_date).toLocaleDateString()}</td>
                    <td>${daysAgo} days ago</td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="deleteSubscription(${sub.id}, '${memberName}', '${sub.month}')">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                </tr>
            `;
        });
        
        historyHTML += `
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeSubscriptionHistoryModal(); addIndividualSubscription(${memberId})">
                    üí∞ Add New Subscription
                </button>
            </div>
        `;
    }
    
    const modalHTML = `
        <div id="subscriptionHistoryModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3>üìã Subscription History - ${memberName}</h3>
                    <span class="close" onclick="closeSubscriptionHistoryModal()">&times;</span>
                </div>
                <div class="modal-body">
                    ${historyHTML}
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('subscriptionHistoryModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Close subscription history modal
function closeSubscriptionHistoryModal() {
    const modal = document.getElementById('subscriptionHistoryModal');
    if (modal) {
        modal.remove();
    }
}

// Delete subscription function
async function deleteSubscription(subscriptionId, memberName, month) {
    if (!confirm(`Are you sure you want to delete subscription for ${memberName} for ${month}?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('subscriptions')
            .delete()
            .eq('id', subscriptionId);
        
        if (error) throw error;
        
        showAlert(`‚úÖ Subscription deleted successfully for ${memberName} (${month})`, 'success');
        
        // Refresh the subscription history modal
        const memberId = allMembers.find(m => m.name === memberName)?.id;
        if (memberId) {
            loadMemberSubscriptionHistory(memberId, memberName);
        }
        
    } catch (error) {
        console.error('Error deleting subscription:', error);
        showAlert('Error deleting subscription: ' + error.message, 'error');
    }
}

        // Utility function to show alerts
        function showAlert(message, type = 'success') {
            // Remove existing alerts
            document.querySelectorAll('.alert').forEach(alert => {
                if (alert.style.position === 'fixed') {
                    alert.remove();
                }
            });
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                min-width: 300px;
                max-width: 500px;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            `;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            alertDiv.innerHTML = `${icons[type] || 'üí°'} ${message}`;
            document.body.appendChild(alertDiv);
            
            // Animate in
            setTimeout(() => {
                alertDiv.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto dismiss
            setTimeout(() => {
                alertDiv.style.transform = 'translateX(100%)';
                setTimeout(() => alertDiv.remove(), 300);
            }, type === 'error' ? 6000 : 4000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editMemberModal');
            const bulkModal = document.getElementById('bulkSelectionModal');
            
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === bulkModal) {
                closeBulkModal();
            }
        };

        // Global function for admin logout (will be provided by auth.js)
        window.adminLogout = window.adminLogout || function() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        };

        console.log('Member Management Portal loaded successfully!');
    </script>
</body>
</html>