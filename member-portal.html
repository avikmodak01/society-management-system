<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Society Member Portal</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Member Portal">
    
    <!-- External JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="security-utils.js"></script>
    
    <style>
        /* Mobile-First Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 100vw;
            margin: 0 auto;
            padding: 15px;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* Mobile-Optimized Login Card */
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px 20px;
            margin: 20px auto;
            max-width: 380px;
            animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .login-header p {
            color: #7f8c8d;
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        /* Mobile-Optimized Input Fields */
        input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 18px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            -webkit-appearance: none;
            appearance: none;
        }

        input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: white;
            transform: scale(1.02);
        }

        /* Large Touch-Friendly Button */
        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            min-height: 56px;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        /* Mobile Dashboard */
        .dashboard {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .dashboard.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Mobile Header */
        .mobile-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .mobile-header h1 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .member-info {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .member-info h2 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .member-info p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            min-height: 36px;
        }

        /* Mobile Tab Navigation */
        .mobile-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: sticky;
            top: 15px;
            z-index: 100;
        }

        .mobile-tab {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #7f8c8d;
            text-align: center;
            min-height: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .mobile-tab.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }

        .mobile-tab .tab-icon {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .mobile-tab .tab-text {
            font-size: 10px;
        }

        /* Mobile Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }

        /* Mobile Summary Cards */
        .mobile-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .summary-card h4 {
            font-size: 11px;
            margin-bottom: 8px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .amount {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .summary-card small {
            font-size: 10px;
            opacity: 0.8;
        }

        /* Mobile Tables */
        .mobile-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 300px;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #f1f1f1;
            font-size: 14px;
        }

        th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        /* Mobile Cards for Complex Data */
        .mobile-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .mobile-card.closed {
            border-left-color: #95a5a6;
            opacity: 0.8;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header h3 {
            color: #2c3e50;
            font-size: 1.1rem;
            margin: 0;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .card-item {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
        }

        .card-item strong {
            display: block;
            color: #2c3e50;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .card-item .value {
            font-weight: 600;
            font-size: 14px;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-active {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        /* Mobile Alerts */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        /* Mobile Filter Section */
        .mobile-filter {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .filter-col {
            flex: 1;
        }

        .filter-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            min-height: 44px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .filter-btn:active {
            transform: scale(0.95);
        }

        .filter-btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        /* Loan Ledger Specific Styles */
        .ledger-transaction-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .transaction-type {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .transaction-date {
            font-size: 12px;
            color: #666;
        }

        .transaction-amounts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .amount-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .amount-label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .amount-value {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
        }

        .running-balances {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #e9ecef;
        }

        .balance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .balance-item {
            text-align: center;
        }

        .balance-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .balance-amount {
            font-size: 14px;
            font-weight: 700;
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 375px) {
            .transaction-amounts {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .filter-btn {
                font-size: 12px;
                padding: 10px 12px;
            }
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* Currency Formatting */
        .currency {
            font-weight: 600;
            color: #27ae60;
        }

        .currency.negative {
            color: #e74c3c;
        }

        /* Safe Area for iOS */
        @supports (padding: max(0px)) {
            .container {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
        }

        /* Small Mobile Devices */
        @media (max-width: 375px) {
            .container {
                padding: 10px;
            }
            
            .login-card {
                padding: 25px 15px;
                margin: 10px auto;
            }
            
            .mobile-header {
                padding: 15px;
            }
            
            .mobile-summary {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        /* Large Mobile Devices */
        @media (min-width: 768px) {
            .container {
                max-width: 500px;
                padding: 20px;
            }
            
            .mobile-summary {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mobile Login Form -->
        <div id="loginSection" class="login-card">
            <div class="login-header">
                <h1>üèõÔ∏è Member Portal</h1>
                <p>Access your account</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="phoneNumber">Mobile Number</label>
                    <input type="tel" id="phoneNumber" placeholder="Enter mobile number" required maxlength="10" inputmode="numeric">
                </div>
                
                <div class="form-group">
                    <label for="pin">4-Digit PIN</label>
                    <input type="password" id="pin" placeholder="Enter PIN" required maxlength="4" inputmode="numeric">
                </div>
                
                <button type="submit" class="btn" id="loginBtn">
                    Login to Portal
                </button>
            </form>
            
            <div class="alert alert-info" style="margin-top: 20px;">
                <strong>üì± Default PIN:</strong> Last 4 digits of mobile<br>
                <strong>üîê Forgot PIN?</strong> Contact admin
            </div>
        </div>

        <!-- Mobile Dashboard -->
        <div id="dashboardSection" class="dashboard">
            <!-- Mobile Header -->
            <div class="mobile-header">
                <button class="logout-btn" onclick="logout()">Logout</button>
                <h1>Welcome to Portal</h1>
                <div class="member-info" id="memberInfo">
                    Loading...
                </div>
            </div>

            <!-- Mobile Tab Navigation -->
            <div class="mobile-tabs">
                <button class="mobile-tab active" onclick="showTab('subscriptions')">
                    <div class="tab-icon">üí≥</div>
                    <div class="tab-text">Subscriptions</div>
                </button>
                <button class="mobile-tab" onclick="showTab('loans')">
                    <div class="tab-icon">üí∞</div>
                    <div class="tab-text">Loans</div>
                </button>
                <button class="mobile-tab" onclick="showTab('summary')">
                    <div class="tab-icon">üìä</div>
                    <div class="tab-text">Summary</div>
                </button>
            </div>

            <!-- Subscriptions Section -->
            <div id="subscriptions" class="content-section active">
                <h2 class="section-title">Subscription History</h2>
                
                <div class="mobile-filter">
                    <div class="filter-row">
                        <div class="filter-col">
                            <label for="subFilterMonth">Filter Month</label>
                            <input type="month" id="subFilterMonth">
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="filter-btn" onclick="filterSubscriptions()">Filter</button>
                            <button class="filter-btn secondary" onclick="showAllSubscriptions()">All</button>
                        </div>
                    </div>
                </div>

                <div class="mobile-summary" id="subscriptionSummary">
                    <div class="summary-card">
                        <h4>Loading...</h4>
                        <div class="amount">‚Çπ0</div>
                    </div>
                </div>

                <div class="mobile-table" id="subscriptionTable">
                    <div class="empty-state">
                        <h3>Loading...</h3>
                        <p>Please wait while we load your data</p>
                    </div>
                </div>
            </div>

            <!-- Loans Section -->
            <div id="loans" class="content-section">
                <h2 class="section-title">Loan Details</h2>
                
                <div class="mobile-summary" id="loanSummary">
                    <div class="summary-card">
                        <h4>Loading...</h4>
                        <div class="amount">‚Çπ0</div>
                    </div>
                </div>

                <!-- Loan View Toggle -->
                <div class="mobile-filter">
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="filter-btn" id="loanSummaryBtn" onclick="showLoanView('summary')">üìã Loan Summary</button>
                        <button class="filter-btn secondary" id="loanLedgerBtn" onclick="showLoanView('ledger')">üìä Detailed Ledger</button>
                    </div>
                </div>

                <!-- Loan Summary View -->
                <div id="loanSummaryView">
                    <div id="loanDetails">
                        <div class="empty-state">
                            <h3>Loading...</h3>
                            <p>Please wait while we load your loan data</p>
                        </div>
                    </div>
                </div>

                <!-- Loan Ledger View -->
                <div id="loanLedgerView" style="display: none;">
                    <div id="loanLedgerContent">
                        <div class="empty-state">
                            <h3>No Detailed Ledger Available</h3>
                            <p>Load loan summary first to view detailed transactions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Section -->
            <div id="summary" class="content-section">
                <h2 class="section-title">Account Summary</h2>
                
                <div class="mobile-summary" id="overallSummary">
                    <div class="summary-card">
                        <h4>Loading...</h4>
                        <div class="amount">‚Çπ0</div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Account Info:</strong><br>
                    ‚Ä¢ Complete financial relationship with society<br>
                    ‚Ä¢ Real-time data from management system<br>
                    ‚Ä¢ Contact admin for any discrepancies
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Script starting...');
        
        // SECURE CONFIGURATION
        let supabase;
        let currentMember = null;
        let appConfig;

        // Initialize Supabase with secure configuration
        async function initSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    console.log('Supabase library not yet available');
                    return false;
                }
                
                // Load secure configuration
                if (!appConfig) {
                    appConfig = await window.SecureConfig.loadConfig();
                    
                    if (!window.SecureConfig.validateConfig()) {
                        throw new Error('Invalid configuration loaded');
                    }
                }
                
                // Initialize Supabase with secure config
                const supabaseConfig = window.SecureConfig.getSupabaseConfig();
                supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey);
                
                console.log('‚úÖ Member Portal initialized securely');
                return true;
                
            } catch (error) {
                console.error('‚ùå Member Portal initialization failed:', error);
                showAlert('System initialization failed. Please refresh the page.', 'error');
                return false;
            }
        }

        // Wait for DOM and Supabase to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            // Try to initialize Supabase
            if (!initSupabase()) {
                // If not available, wait a bit and try again
                setTimeout(() => {
                    if (!initSupabase()) {
                        console.error('Supabase failed to load');
                        showAlert('Failed to connect to database. Please refresh the page.', 'error');
                        return;
                    }
                    continueInitialization();
                }, 1000);
            } else {
                continueInitialization();
            }
        });

        function continueInitialization() {
            console.log('Continuing initialization...');
            
            setupEventListeners();
            
            // Check saved login
            const savedMember = localStorage.getItem('loggedInMember');
            if (savedMember) {
                try {
                    currentMember = JSON.parse(savedMember);
                    console.log('Found saved member:', currentMember.name);
                    showDashboard();
                } catch (error) {
                    console.error('Error parsing saved member:', error);
                    localStorage.removeItem('loggedInMember');
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            const loginForm = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                console.log('Login form event listener added');
            }

            if (loginBtn) {
                loginBtn.addEventListener('click', function(e) {
                    console.log('Login button clicked directly');
                    // Only handle if it's not already a form submit
                    if (e.target.form) {
                        // Let form submit handle it
                        return;
                    }
                    e.preventDefault();
                    handleLogin(e);
                });
            }

            // Numeric input only
            const phoneInput = document.getElementById('phoneNumber');
            const pinInput = document.getElementById('pin');
            
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }
            
            if (pinInput) {
                pinInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }

            console.log('Event listeners setup complete');
        }

        // Handle login
        async function handleLogin(event) {
            console.log('handleLogin called');
            event.preventDefault();
            
            if (!supabase) {
                showAlert('Database connection not ready. Please try again.', 'error');
                return;
            }
            
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const pin = document.getElementById('pin').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            
            console.log('Login attempt - Phone:', phoneNumber, 'PIN length:', pin.length);
            
            // Validate
            if (phoneNumber.length !== 10) {
                showAlert('Enter valid 10-digit mobile number', 'error');
                return;
            }
            
            if (pin.length !== 4) {
                showAlert('Enter valid 4-digit PIN', 'error');
                return;
            }

            // Loading state
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading"></span>Logging in...';

            try {
                // Check member
                console.log('Checking member in database...');
                const { data: member, error: memberError } = await supabase
                    .from('members')
                    .select('*')
                    .eq('contact', phoneNumber)
                    .eq('status', 'active')
                    .single();

                if (memberError) {
                    console.error('Member lookup error:', memberError);
                    if (memberError.code === 'PGRST116') {
                        throw new Error('Member not found or inactive');
                    }
                    throw memberError;
                }

                console.log('Member found:', member.name);

                // Get PIN
                let memberPin = phoneNumber.slice(-4);
                
                try {
                    const { data: pinData } = await supabase
                        .from('member_pins')
                        .select('pin')
                        .eq('member_id', member.id)
                        .single();

                    if (pinData) {
                        memberPin = pinData.pin;
                        console.log('Using custom PIN');
                    } else {
                        console.log('Using default PIN');
                    }
                } catch (pinError) {
                    console.log('No custom PIN found, using default');
                }

                // Verify PIN
                if (pin !== memberPin) {
                    throw new Error('Invalid PIN');
                }

                // Success
                currentMember = member;
                localStorage.setItem('loggedInMember', JSON.stringify(member));
                
                showAlert('Welcome ' + member.name + '!', 'success');
                setTimeout(showDashboard, 1000);

            } catch (error) {
                console.error('Login error:', error);
                showAlert(error.message || 'Login failed', 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Login to Portal';
            }
        }

        // Show dashboard
        async function showDashboard() {
            console.log('Showing dashboard...');
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').classList.add('active');
            
            // Populate member info
            document.getElementById('memberInfo').innerHTML = `
                <h2>${currentMember.name}</h2>
                <p>ID: MS${String(currentMember.id).padStart(4, '0')} | ${currentMember.contact}</p>
            `;

            // Load data
            try {
                await Promise.all([
                    loadSubscriptionData(),
                    loadLoanData(),
                    loadSummaryData()
                ]);
                console.log('All data loaded successfully');
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Some data could not load', 'error');
            }
        }

        // Load subscription data
        async function loadSubscriptionData(filterMonth = null) {
            try {
                let query = supabase
                    .from('subscriptions')
                    .select('*')
                    .eq('member_id', currentMember.id)
                    .order('month', { ascending: false });

                if (filterMonth) {
                    query = query.eq('month', filterMonth);
                }

                const { data: subscriptions, error } = await query;
                if (error) throw error;

                const subs = subscriptions || [];
                displaySubscriptionSummary(subs);
                displaySubscriptionTable(subs);

            } catch (error) {
                console.error('Error loading subscriptions:', error);
                showAlert('Error loading subscriptions', 'error');
            }
        }

        // Display subscription summary
        function displaySubscriptionSummary(subscriptions) {
            const totalPaid = subscriptions.reduce((sum, sub) => sum + sub.amount, 0);
            const currentYear = new Date().getFullYear();
            const thisYearCount = subscriptions.filter(sub => 
                sub.month.startsWith(currentYear.toString())
            ).length;
            const lastPayment = subscriptions[0];

            document.getElementById('subscriptionSummary').innerHTML = `
                <div class="summary-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                    <h4>Total Paid</h4>
                    <div class="amount">${formatCurrency(totalPaid)}</div>
                    <small>All subscriptions</small>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                    <h4>This Year</h4>
                    <div class="amount">${thisYearCount}</div>
                    <small>Payments in ${currentYear}</small>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                    <h4>Last Payment</h4>
                    <div class="amount">${lastPayment ? formatCurrency(lastPayment.amount) : '‚Çπ0'}</div>
                    <small>${lastPayment ? formatMonth(lastPayment.month) : 'No payments'}</small>
                </div>
            `;
        }

        // Display subscription table
        function displaySubscriptionTable(subscriptions) {
            if (subscriptions.length === 0) {
                document.getElementById('subscriptionTable').innerHTML = `
                    <div class="empty-state">
                        <h3>No Subscriptions</h3>
                        <p>No subscription payments recorded</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            subscriptions.forEach(sub => {
                tableHTML += `
                    <tr>
                        <td><strong>${formatMonth(sub.month)}</strong></td>
                        <td><span class="currency">${formatCurrency(sub.amount)}</span></td>
                        <td>${new Date(sub.payment_date).toLocaleDateString()}</td>
                        <td><span class="status-badge status-paid">Paid</span></td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('subscriptionTable').innerHTML = tableHTML;
        }

        // Load loan data
        async function loadLoanData() {
            try {
                const { data: loans, error } = await supabase
                    .from('loans')
                    .select(`
                        *,
                        loan_repayments(principal_amount, interest_amount, payment_date),
                        loan_interest_accruals(accrued_amount, accrual_month)
                    `)
                    .eq('member_id', currentMember.id)
                    .order('loan_date', { ascending: false });

                if (error) throw error;

                const loanData = loans || [];
                displayLoanSummary(loanData);
                displayLoanCards(loanData);
                
                // Store loan data globally for ledger view
                window.memberLoanData = loanData;

            } catch (error) {
                console.error('Error loading loans:', error);
                showAlert('Error loading loans', 'error');
            }
        }

        // Show loan view (summary or ledger)
        function showLoanView(viewType) {
            const summaryView = document.getElementById('loanSummaryView');
            const ledgerView = document.getElementById('loanLedgerView');
            const summaryBtn = document.getElementById('loanSummaryBtn');
            const ledgerBtn = document.getElementById('loanLedgerBtn');

            if (viewType === 'summary') {
                summaryView.style.display = 'block';
                ledgerView.style.display = 'none';
                summaryBtn.classList.remove('secondary');
                ledgerBtn.classList.add('secondary');
            } else if (viewType === 'ledger') {
                summaryView.style.display = 'none';
                ledgerView.style.display = 'block';
                summaryBtn.classList.add('secondary');
                ledgerBtn.classList.remove('secondary');
                
                // Generate detailed ledger
                generateMobileLoanLedger();
            }
        }

        // Generate mobile-friendly loan ledger
        async function generateMobileLoanLedger() {
            try {
                const loans = window.memberLoanData || [];
                
                if (!loans || loans.length === 0) {
                    document.getElementById('loanLedgerContent').innerHTML = `
                        <div class="empty-state">
                            <h3>No Loans Found</h3>
                            <p>This member has no loan history</p>
                        </div>
                    `;
                    return;
                }

                let ledgerHTML = `
                    <h3 style="text-align: center; margin-bottom: 20px;">üìä Complete Loan Ledger</h3>
                    <p style="text-align: center; margin-bottom: 20px; font-style: italic;">Month-wise transaction history for all loans</p>
                `;

                const allTransactions = [];
                let totalPrincipalDisbursed = 0;
                let totalInterestAccrued = 0;
                let totalPrincipalPaid = 0;
                let totalInterestPaid = 0;

                // Process each loan
                for (const loan of loans) {
                    totalPrincipalDisbursed += loan.amount;

                    // Add loan disbursement transaction
                    allTransactions.push({
                        date: loan.loan_date,
                        type: 'Loan Disbursement',
                        loan_id: loan.id,
                        description: `Loan LN${String(loan.id).padStart(4, '0')} disbursed`,
                        principal_debit: loan.amount,
                        principal_credit: 0,
                        interest_debit: 0,
                        interest_credit: 0,
                        interest_type: loan.interest_rate_type,
                        interest_rate: loan.manual_interest_rate
                    });

                    // Add interest accruals
                    if (loan.loan_interest_accruals) {
                        loan.loan_interest_accruals.forEach(accrual => {
                            totalInterestAccrued += accrual.accrued_amount;
                            
                            allTransactions.push({
                                date: new Date().toISOString().split('T')[0], // Use current date as accrual date
                                type: 'Interest Accrual',
                                loan_id: loan.id,
                                description: `Interest for ${accrual.accrual_month}`,
                                principal_debit: 0,
                                principal_credit: 0,
                                interest_debit: accrual.accrued_amount,
                                interest_credit: 0,
                                interest_type: loan.interest_rate_type,
                                interest_rate: loan.manual_interest_rate
                            });
                        });
                    }

                    // Add repayments
                    if (loan.loan_repayments) {
                        loan.loan_repayments.forEach(repayment => {
                            totalPrincipalPaid += repayment.principal_amount;
                            totalInterestPaid += repayment.interest_amount;
                            
                            allTransactions.push({
                                date: repayment.payment_date,
                                type: 'Repayment',
                                loan_id: loan.id,
                                description: `Payment received`,
                                principal_debit: 0,
                                principal_credit: repayment.principal_amount,
                                interest_debit: 0,
                                interest_credit: repayment.interest_amount,
                                interest_type: loan.interest_rate_type,
                                interest_rate: loan.manual_interest_rate
                            });
                        });
                    }
                }

                // Sort all transactions by date
                allTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Create summary cards
                const outstandingPrincipal = totalPrincipalDisbursed - totalPrincipalPaid;
                const outstandingInterest = totalInterestAccrued - totalInterestPaid;
                const totalOutstanding = outstandingPrincipal + Math.max(0, outstandingInterest);

                ledgerHTML += `
                    <div class="mobile-summary">
                        <div class="summary-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                            <h4>Total Disbursed</h4>
                            <div class="amount">${formatCurrency(totalPrincipalDisbursed)}</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                            <h4>Interest Accrued</h4>
                            <div class="amount">${formatCurrency(totalInterestAccrued)}</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                            <h4>Total Repaid</h4>
                            <div class="amount">${formatCurrency(totalPrincipalPaid + totalInterestPaid)}</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                            <h4>Outstanding</h4>
                            <div class="amount">${formatCurrency(totalOutstanding)}</div>
                        </div>
                    </div>
                `;

                // Create mobile-friendly transaction cards
                ledgerHTML += `
                    <h4 style="margin: 20px 0; color: #2c3e50;">üìù Transaction History</h4>
                `;

                let runningPrincipalBalance = 0;
                let runningInterestBalance = 0;

                allTransactions.forEach((transaction, index) => {
                    // Update running balances
                    runningPrincipalBalance += transaction.principal_debit - transaction.principal_credit;
                    runningInterestBalance += transaction.interest_debit - transaction.interest_credit;
                    
                    // Ensure interest balance doesn't go negative
                    runningInterestBalance = Math.max(0, runningInterestBalance);

                    const typeColor = transaction.type === 'Loan Disbursement' ? '#3498db' : 
                                     transaction.type === 'Interest Accrual' ? '#f39c12' : '#27ae60';
                    
                    const typeIcon = transaction.type === 'Loan Disbursement' ? 'üí∞' : 
                                    transaction.type === 'Interest Accrual' ? 'üìà' : 'üíµ';

                    ledgerHTML += `
                        <div class="mobile-card" style="margin-bottom: 15px;">
                            <div class="card-header">
                                <h3 style="color: ${typeColor};">${typeIcon} ${transaction.type}</h3>
                                <small style="color: #666;">${new Date(transaction.date).toLocaleDateString()}</small>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <strong>Loan:</strong> LN${String(transaction.loan_id).padStart(4, '0')} - ${transaction.description}
                            </div>
                            
                            <div class="card-grid">
                                <div class="card-item">
                                    <strong>Principal Dr.</strong>
                                    <div class="value">${transaction.principal_debit > 0 ? formatCurrency(transaction.principal_debit) : '-'}</div>
                                </div>
                                <div class="card-item">
                                    <strong>Principal Cr.</strong>
                                    <div class="value">${transaction.principal_credit > 0 ? formatCurrency(transaction.principal_credit) : '-'}</div>
                                </div>
                                <div class="card-item">
                                    <strong>Interest Dr.</strong>
                                    <div class="value">${transaction.interest_debit > 0 ? formatCurrency(transaction.interest_debit) : '-'}</div>
                                </div>
                                <div class="card-item">
                                    <strong>Interest Cr.</strong>
                                    <div class="value">${transaction.interest_credit > 0 ? formatCurrency(transaction.interest_credit) : '-'}</div>
                                </div>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                                    <div>
                                        <strong style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Principal Balance</strong>
                                        <span class="currency ${runningPrincipalBalance > 0 ? 'negative' : ''}" style="font-weight: bold;">${formatCurrency(runningPrincipalBalance)}</span>
                                    </div>
                                    <div>
                                        <strong style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Interest Balance</strong>
                                        <span class="currency ${runningInterestBalance > 0 ? 'negative' : ''}" style="font-weight: bold;">${formatCurrency(runningInterestBalance)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Final balance summary
                ledgerHTML += `
                    <div class="mobile-card" style="background: linear-gradient(135deg, #34495e, #2c3e50); color: white;">
                        <div class="card-header">
                            <h3>üìä Final Balances</h3>
                        </div>
                        
                        <div class="card-grid">
                            <div class="card-item" style="background: rgba(255,255,255,0.1);">
                                <strong style="color: white;">Outstanding Principal</strong>
                                <div class="value" style="color: white; font-weight: bold;">${formatCurrency(outstandingPrincipal)}</div>
                            </div>
                            <div class="card-item" style="background: rgba(255,255,255,0.1);">
                                <strong style="color: white;">Outstanding Interest</strong>
                                <div class="value" style="color: white; font-weight: bold;">${formatCurrency(Math.max(0, outstandingInterest))}</div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <strong style="font-size: 16px; color: white;">Total Outstanding: ${formatCurrency(totalOutstanding)}</strong>
                        </div>
                    </div>
                `;

                ledgerHTML += `
                    <div style="margin-top: 20px; padding: 15px; background-color: #e8f4fd; border-radius: 8px; border-left: 4px solid #3498db;">
                        <strong>üìù Ledger Notes:</strong><br>
                        ‚Ä¢ <strong>Dr. (Debit):</strong> Increases the balance (loans disbursed, interest accrued)<br>
                        ‚Ä¢ <strong>Cr. (Credit):</strong> Decreases the balance (payments received)<br>
                        ‚Ä¢ <strong>Interest Balance:</strong> Cannot go below zero (overpayments don't create negative interest)<br>
                        ‚Ä¢ All transactions are shown chronologically with running balances<br>
                        ‚Ä¢ Swipe left/right on transaction cards for better viewing on mobile
                    </div>
                `;

                document.getElementById('loanLedgerContent').innerHTML = ledgerHTML;

            } catch (error) {
                console.error('Error generating loan ledger:', error);
                document.getElementById('loanLedgerContent').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Ledger</h3>
                        <p>Unable to generate detailed loan ledger</p>
                    </div>
                `;
            }
        }

        // Display loan summary
        function displayLoanSummary(loans) {
            const activeLoans = loans.filter(loan => loan.status === 'active');
            const totalDisbursed = loans.reduce((sum, loan) => sum + loan.amount, 0);
            
            let totalOutstanding = 0;
            
            loans.forEach(loan => {
                if (loan.status === 'active') {
                    const totalPrincipalPaid = loan.loan_repayments?.reduce((sum, rep) => sum + rep.principal_amount, 0) || 0;
                    const totalInterestPaid = loan.loan_repayments?.reduce((sum, rep) => sum + rep.interest_amount, 0) || 0;
                    const totalInterestAccrued = loan.loan_interest_accruals?.reduce((sum, acc) => sum + acc.accrued_amount, 0) || 0;
                    
                    const principalBalance = loan.outstanding_amount !== null ? 
                        loan.outstanding_amount : 
                        loan.amount - totalPrincipalPaid;
                    
                    const interestBalance = Math.max(0, totalInterestAccrued - totalInterestPaid);
                    totalOutstanding += principalBalance + interestBalance;
                }
            });

            document.getElementById('loanSummary').innerHTML = `
                <div class="summary-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                    <h4>Total Loans</h4>
                    <div class="amount">${formatCurrency(totalDisbursed)}</div>
                    <small>All time</small>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                    <h4>Outstanding</h4>
                    <div class="amount">${formatCurrency(totalOutstanding)}</div>
                    <small>Current balance</small>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                    <h4>Active Loans</h4>
                    <div class="amount">${activeLoans.length}</div>
                    <small>Currently active</small>
                </div>
            `;
        }

        // Display loan cards
        function displayLoanCards(loans) {
            if (loans.length === 0) {
                document.getElementById('loanDetails').innerHTML = `
                    <div class="empty-state">
                        <h3>No Loans</h3>
                        <p>No loan history found</p>
                    </div>
                `;
                return;
            }

            let cardsHTML = '';

            loans.forEach(loan => {
                const totalPrincipalPaid = loan.loan_repayments?.reduce((sum, rep) => sum + rep.principal_amount, 0) || 0;
                const totalInterestPaid = loan.loan_repayments?.reduce((sum, rep) => sum + rep.interest_amount, 0) || 0;
                const totalInterestAccrued = loan.loan_interest_accruals?.reduce((sum, acc) => sum + acc.accrued_amount, 0) || 0;

                const principalBalance = loan.outstanding_amount !== null ? 
                    loan.outstanding_amount : 
                    loan.amount - totalPrincipalPaid;
                
                const interestBalance = Math.max(0, totalInterestAccrued - totalInterestPaid);
                const totalOutstanding = principalBalance + interestBalance;

                let rateDisplay = '';
                if (loan.interest_rate_type === 'progressive') {
                    rateDisplay = '2%/3% Progressive';
                } else if (loan.interest_rate_type === 'flat') {
                    rateDisplay = `${loan.manual_interest_rate}% Flat`;
                } else {
                    rateDisplay = '0% Interest';
                }

                cardsHTML += `
                    <div class="mobile-card ${loan.status === 'closed' ? 'closed' : ''}">
                        <div class="card-header">
                            <h3>Loan LN${String(loan.id).padStart(4, '0')}</h3>
                            <span class="status-badge ${loan.status === 'active' ? 'status-active' : 'status-closed'}">
                                ${loan.status.toUpperCase()}
                            </span>
                        </div>
                        
                        <div class="card-grid">
                            <div class="card-item">
                                <strong>Loan Amount</strong>
                                <div class="value currency">${formatCurrency(loan.amount)}</div>
                            </div>
                            <div class="card-item">
                                <strong>Outstanding</strong>
                                <div class="value currency ${totalOutstanding > 0 ? 'negative' : ''}">${formatCurrency(totalOutstanding)}</div>
                            </div>
                            <div class="card-item">
                                <strong>Interest Rate</strong>
                                <div class="value">${rateDisplay}</div>
                            </div>
                            <div class="card-item">
                                <strong>Loan Date</strong>
                                <div class="value">${new Date(loan.loan_date).toLocaleDateString()}</div>
                            </div>
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                                <div>
                                    <strong style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Principal Balance</strong>
                                    <span class="currency ${principalBalance > 0 ? 'negative' : ''}">${formatCurrency(principalBalance)}</span>
                                </div>
                                <div>
                                    <strong style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Interest Due</strong>
                                    <span class="currency ${interestBalance > 0 ? 'negative' : ''}">${formatCurrency(interestBalance)}</span>
                                </div>
                            </div>
                        </div>
                `;

                // Recent payments
                if (loan.loan_repayments && loan.loan_repayments.length > 0) {
                    const recentPayments = loan.loan_repayments
                        .sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date))
                        .slice(0, 3);

                    cardsHTML += `
                        <div style="margin-top: 15px;">
                            <strong style="color: #2c3e50; font-size: 14px;">Recent Payments:</strong>
                            <div style="margin-top: 10px;">
                    `;

                    recentPayments.forEach(payment => {
                        cardsHTML += `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                <span style="font-size: 13px;">${new Date(payment.payment_date).toLocaleDateString()}</span>
                                <span style="font-size: 13px; font-weight: 600;">${formatCurrency(payment.principal_amount + payment.interest_amount)}</span>
                            </div>
                        `;
                    });

                    cardsHTML += '</div></div>';
                }

                cardsHTML += '</div>';
            });

            document.getElementById('loanDetails').innerHTML = cardsHTML;
        }

        // Load summary data
        async function loadSummaryData() {
            try {
                // Get subscription summary
                const { data: subscriptions, error: subError } = await supabase
                    .from('subscriptions')
                    .select('amount')
                    .eq('member_id', currentMember.id);

                if (subError) throw subError;

                // Get loan summary
                const { data: loans, error: loanError } = await supabase
                    .from('loans')
                    .select(`
                        amount, outstanding_amount, status,
                        loan_repayments(principal_amount, interest_amount)
                    `)
                    .eq('member_id', currentMember.id);

                if (loanError) throw loanError;

                displayOverallSummary(subscriptions || [], loans || []);

            } catch (error) {
                console.error('Error loading summary:', error);
                showAlert('Error loading summary', 'error');
            }
        }

        // Display overall summary
        function displayOverallSummary(subscriptions, loans) {
            const totalSubscriptions = subscriptions.reduce((sum, sub) => sum + sub.amount, 0);
            const totalLoansDisbursed = loans.reduce((sum, loan) => sum + loan.amount, 0);
            
            let currentOutstanding = 0;
            let totalRepaid = 0;
            
            loans.forEach(loan => {
                const totalPaid = loan.loan_repayments?.reduce((sum, rep) => sum + rep.principal_amount + rep.interest_amount, 0) || 0;
                totalRepaid += totalPaid;
                
                if (loan.status === 'active') {
                    const principalBalance = loan.outstanding_amount !== null ? 
                        loan.outstanding_amount : 
                        loan.amount - (loan.loan_repayments?.reduce((sum, rep) => sum + rep.principal_amount, 0) || 0);
                    currentOutstanding += principalBalance;
                }
            });

            const netContribution = totalSubscriptions - currentOutstanding;

            document.getElementById('overallSummary').innerHTML = `
                <div class="summary-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                    <h4>Contributions</h4>
                    <div class="amount">${formatCurrency(totalSubscriptions)}</div>
                    <small>Total subscriptions</small>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                    <h4>Loans Taken</h4>
                    <div class="amount">${formatCurrency(totalLoansDisbursed)}</div>
                    <small>Total disbursed</small>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                    <h4>Repaid</h4>
                    <div class="amount">${formatCurrency(totalRepaid)}</div>
                    <small>Principal + Interest</small>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, ${netContribution >= 0 ? '#27ae60, #229954' : '#e74c3c, #c0392b'});">
                    <h4>Net Position</h4>
                    <div class="amount">${formatCurrency(Math.abs(netContribution))}</div>
                    <small>${netContribution >= 0 ? 'Net contributor' : 'Net borrower'}</small>
                </div>
            `;
        }

        // Filter subscriptions
        function filterSubscriptions() {
            const filterMonth = document.getElementById('subFilterMonth').value;
            if (!filterMonth) {
                showAlert('Please select a month', 'error');
                return;
            }
            loadSubscriptionData(filterMonth);
        }

        // Show all subscriptions
        function showAllSubscriptions() {
            document.getElementById('subFilterMonth').value = '';
            loadSubscriptionData();
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active from tabs
            document.querySelectorAll('.mobile-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected section
            document.getElementById(tabName).classList.add('active');

            // Add active to clicked tab
            event.target.closest('.mobile-tab').classList.add('active');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('loggedInMember');
                currentMember = null;
                
                // Reset UI
                document.getElementById('dashboardSection').classList.remove('active');
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('loginForm').reset();
                
                // Reset tabs
                document.querySelectorAll('.mobile-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
                document.querySelector('.mobile-tab').classList.add('active');
                document.getElementById('subscriptions').classList.add('active');
                
                showAlert('Logged out successfully', 'success');
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        }

        function formatMonth(monthString) {
            try {
                const date = new Date(monthString + '-01');
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short' 
                });
            } catch (error) {
                return monthString;
            }
        }

        function showAlert(message, type = 'success') {
            // Remove existing alerts
            document.querySelectorAll('.alert').forEach(alert => {
                if (alert.style.position === 'fixed') {
                    alert.remove();
                }
            });
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10000;
                max-width: 90%;
                min-width: 280px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                border-radius: 12px;
                animation: slideDown 0.3s ease;
            `;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            alertDiv.innerHTML = `${icons[type] || 'üí°'} ${message}`;
            document.body.appendChild(alertDiv);
            
            // Auto dismiss
            setTimeout(() => {
                alertDiv.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => alertDiv.remove(), 300);
            }, type === 'error' ? 5000 : 3000);
        }

        // Add slide animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from { transform: translate(-50%, -100%); opacity: 0; }
                to { transform: translate(-50%, 0); opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translate(-50%, 0); opacity: 1; }
                to { transform: translate(-50%, -100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        console.log('Mobile Member Portal script loaded successfully!');
    </script>
</body>
</html>